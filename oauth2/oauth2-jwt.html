<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>引入 JWT | 江南一点雨</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="https://open.weixin.qq.com/qr/code?username=a_javaboy">
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.3f949b7f.css" as="style"><link rel="preload" href="/assets/js/app.93cfb041.js" as="script"><link rel="preload" href="/assets/js/2.afd40777.js" as="script"><link rel="preload" href="/assets/js/64.54bb5e4b.js" as="script"><link rel="prefetch" href="/assets/js/10.f65a90e2.js"><link rel="prefetch" href="/assets/js/100.3bcf32ff.js"><link rel="prefetch" href="/assets/js/101.bd9ebd49.js"><link rel="prefetch" href="/assets/js/102.392f968e.js"><link rel="prefetch" href="/assets/js/103.afadf5bf.js"><link rel="prefetch" href="/assets/js/104.c8312846.js"><link rel="prefetch" href="/assets/js/105.97a4170a.js"><link rel="prefetch" href="/assets/js/106.9f0ef153.js"><link rel="prefetch" href="/assets/js/107.bb303c1b.js"><link rel="prefetch" href="/assets/js/108.45e76aae.js"><link rel="prefetch" href="/assets/js/109.7e4e3e84.js"><link rel="prefetch" href="/assets/js/11.5e8094b3.js"><link rel="prefetch" href="/assets/js/110.839e4506.js"><link rel="prefetch" href="/assets/js/111.50cc5969.js"><link rel="prefetch" href="/assets/js/112.715e408b.js"><link rel="prefetch" href="/assets/js/113.aaba78f1.js"><link rel="prefetch" href="/assets/js/114.6a025439.js"><link rel="prefetch" href="/assets/js/115.8b36028e.js"><link rel="prefetch" href="/assets/js/116.2aa7851e.js"><link rel="prefetch" href="/assets/js/117.75ea5460.js"><link rel="prefetch" href="/assets/js/118.26bc5dca.js"><link rel="prefetch" href="/assets/js/119.0f7df258.js"><link rel="prefetch" href="/assets/js/12.4f05d2f8.js"><link rel="prefetch" href="/assets/js/120.f7b3a0ed.js"><link rel="prefetch" href="/assets/js/121.cf863463.js"><link rel="prefetch" href="/assets/js/122.fa3cfbdb.js"><link rel="prefetch" href="/assets/js/123.adc5157d.js"><link rel="prefetch" href="/assets/js/124.fbe6a3bf.js"><link rel="prefetch" href="/assets/js/125.d3e4c526.js"><link rel="prefetch" href="/assets/js/126.2667f20c.js"><link rel="prefetch" href="/assets/js/127.a992245e.js"><link rel="prefetch" href="/assets/js/128.e2dc5f84.js"><link rel="prefetch" href="/assets/js/129.276d62b1.js"><link rel="prefetch" href="/assets/js/13.6be298bf.js"><link rel="prefetch" href="/assets/js/130.df0fd4f2.js"><link rel="prefetch" href="/assets/js/131.e4e2b4dd.js"><link rel="prefetch" href="/assets/js/132.42ac2755.js"><link rel="prefetch" href="/assets/js/133.4d19914d.js"><link rel="prefetch" href="/assets/js/134.eee5f7f1.js"><link rel="prefetch" href="/assets/js/135.63554b27.js"><link rel="prefetch" href="/assets/js/136.a6bc1760.js"><link rel="prefetch" href="/assets/js/137.5fc69fd8.js"><link rel="prefetch" href="/assets/js/138.de23da83.js"><link rel="prefetch" href="/assets/js/139.a1faeb31.js"><link rel="prefetch" href="/assets/js/14.815db104.js"><link rel="prefetch" href="/assets/js/140.95dbf73f.js"><link rel="prefetch" href="/assets/js/141.b4542eae.js"><link rel="prefetch" href="/assets/js/142.f9296937.js"><link rel="prefetch" href="/assets/js/143.9ea81dee.js"><link rel="prefetch" href="/assets/js/144.a423b13c.js"><link rel="prefetch" href="/assets/js/145.7da590a6.js"><link rel="prefetch" href="/assets/js/146.bca8af1b.js"><link rel="prefetch" href="/assets/js/147.0aa847b1.js"><link rel="prefetch" href="/assets/js/148.8e722bc5.js"><link rel="prefetch" href="/assets/js/149.082e9ce8.js"><link rel="prefetch" href="/assets/js/15.f278054c.js"><link rel="prefetch" href="/assets/js/150.57c0d03e.js"><link rel="prefetch" href="/assets/js/151.bfeac464.js"><link rel="prefetch" href="/assets/js/152.1ed78952.js"><link rel="prefetch" href="/assets/js/153.51ae1560.js"><link rel="prefetch" href="/assets/js/154.a6f7351f.js"><link rel="prefetch" href="/assets/js/155.8cb2b9b7.js"><link rel="prefetch" href="/assets/js/156.baf79d5d.js"><link rel="prefetch" href="/assets/js/157.6dc937e3.js"><link rel="prefetch" href="/assets/js/158.f9688b9c.js"><link rel="prefetch" href="/assets/js/159.9c2d77a9.js"><link rel="prefetch" href="/assets/js/16.345bdcfc.js"><link rel="prefetch" href="/assets/js/160.c928cf3c.js"><link rel="prefetch" href="/assets/js/161.5d3727ba.js"><link rel="prefetch" href="/assets/js/162.bb1e7f33.js"><link rel="prefetch" href="/assets/js/163.049f7d18.js"><link rel="prefetch" href="/assets/js/164.a480bd3f.js"><link rel="prefetch" href="/assets/js/165.c8f91cd5.js"><link rel="prefetch" href="/assets/js/166.f0a0e356.js"><link rel="prefetch" href="/assets/js/167.54930ff6.js"><link rel="prefetch" href="/assets/js/168.2702d69f.js"><link rel="prefetch" href="/assets/js/169.44923723.js"><link rel="prefetch" href="/assets/js/17.a076d059.js"><link rel="prefetch" href="/assets/js/170.0e2e92d4.js"><link rel="prefetch" href="/assets/js/171.e63c9b1d.js"><link rel="prefetch" href="/assets/js/172.c18ef95a.js"><link rel="prefetch" href="/assets/js/173.a78b9057.js"><link rel="prefetch" href="/assets/js/174.35a568dc.js"><link rel="prefetch" href="/assets/js/175.aaff1ff2.js"><link rel="prefetch" href="/assets/js/176.10d8a2e2.js"><link rel="prefetch" href="/assets/js/177.83ea0cb0.js"><link rel="prefetch" href="/assets/js/178.3c9de5ed.js"><link rel="prefetch" href="/assets/js/179.28e6d588.js"><link rel="prefetch" href="/assets/js/18.542b7e9d.js"><link rel="prefetch" href="/assets/js/180.6c49aa48.js"><link rel="prefetch" href="/assets/js/181.5a053633.js"><link rel="prefetch" href="/assets/js/182.b23e7d08.js"><link rel="prefetch" href="/assets/js/183.ee09403b.js"><link rel="prefetch" href="/assets/js/184.94593e4b.js"><link rel="prefetch" href="/assets/js/185.ea14675f.js"><link rel="prefetch" href="/assets/js/186.105f44fd.js"><link rel="prefetch" href="/assets/js/187.13bdebf6.js"><link rel="prefetch" href="/assets/js/188.df5be68c.js"><link rel="prefetch" href="/assets/js/189.8feb4ee4.js"><link rel="prefetch" href="/assets/js/19.741384a0.js"><link rel="prefetch" href="/assets/js/190.8c35be02.js"><link rel="prefetch" href="/assets/js/191.9bbb2940.js"><link rel="prefetch" href="/assets/js/192.77be398f.js"><link rel="prefetch" href="/assets/js/193.401d4d9e.js"><link rel="prefetch" href="/assets/js/194.ce411ee2.js"><link rel="prefetch" href="/assets/js/195.10a07ccc.js"><link rel="prefetch" href="/assets/js/196.74cbc7e7.js"><link rel="prefetch" href="/assets/js/197.5d03c5b7.js"><link rel="prefetch" href="/assets/js/198.c298c39b.js"><link rel="prefetch" href="/assets/js/199.29ec26b9.js"><link rel="prefetch" href="/assets/js/20.4c668583.js"><link rel="prefetch" href="/assets/js/200.9b042f85.js"><link rel="prefetch" href="/assets/js/201.ce4fe568.js"><link rel="prefetch" href="/assets/js/202.97cae704.js"><link rel="prefetch" href="/assets/js/203.9f870d68.js"><link rel="prefetch" href="/assets/js/204.2796778b.js"><link rel="prefetch" href="/assets/js/205.8efe9247.js"><link rel="prefetch" href="/assets/js/206.ff06ce73.js"><link rel="prefetch" href="/assets/js/207.0402326b.js"><link rel="prefetch" href="/assets/js/208.2bd6489b.js"><link rel="prefetch" href="/assets/js/209.ca24b4e7.js"><link rel="prefetch" href="/assets/js/21.aebbbd15.js"><link rel="prefetch" href="/assets/js/210.4d61626d.js"><link rel="prefetch" href="/assets/js/211.6c198d71.js"><link rel="prefetch" href="/assets/js/212.52494de3.js"><link rel="prefetch" href="/assets/js/213.43f986d0.js"><link rel="prefetch" href="/assets/js/214.3403d0f9.js"><link rel="prefetch" href="/assets/js/215.ba7b6da8.js"><link rel="prefetch" href="/assets/js/216.ecbe6232.js"><link rel="prefetch" href="/assets/js/217.70deb9f1.js"><link rel="prefetch" href="/assets/js/218.de783ea7.js"><link rel="prefetch" href="/assets/js/219.4efc57bc.js"><link rel="prefetch" href="/assets/js/22.f361a824.js"><link rel="prefetch" href="/assets/js/220.5dc860c4.js"><link rel="prefetch" href="/assets/js/221.7a3c5614.js"><link rel="prefetch" href="/assets/js/222.b5a275ab.js"><link rel="prefetch" href="/assets/js/223.a8ea0f32.js"><link rel="prefetch" href="/assets/js/224.b2f5c374.js"><link rel="prefetch" href="/assets/js/225.0ab9bbe5.js"><link rel="prefetch" href="/assets/js/226.73ddbdc1.js"><link rel="prefetch" href="/assets/js/227.a8617bac.js"><link rel="prefetch" href="/assets/js/228.184e2034.js"><link rel="prefetch" href="/assets/js/229.a7efe08d.js"><link rel="prefetch" href="/assets/js/23.a04c99fe.js"><link rel="prefetch" href="/assets/js/230.49a88e1b.js"><link rel="prefetch" href="/assets/js/231.a422f33e.js"><link rel="prefetch" href="/assets/js/232.c323a194.js"><link rel="prefetch" href="/assets/js/233.5edbdef4.js"><link rel="prefetch" href="/assets/js/234.9f0a13bb.js"><link rel="prefetch" href="/assets/js/235.54a4fc37.js"><link rel="prefetch" href="/assets/js/236.d2d69ec5.js"><link rel="prefetch" href="/assets/js/237.64f6dcea.js"><link rel="prefetch" href="/assets/js/238.61c501f3.js"><link rel="prefetch" href="/assets/js/239.a33bb2dd.js"><link rel="prefetch" href="/assets/js/24.5bc3cf94.js"><link rel="prefetch" href="/assets/js/240.f7f4c0ba.js"><link rel="prefetch" href="/assets/js/241.65fc5fa2.js"><link rel="prefetch" href="/assets/js/242.0491824c.js"><link rel="prefetch" href="/assets/js/243.3f9577d5.js"><link rel="prefetch" href="/assets/js/244.9649ec6d.js"><link rel="prefetch" href="/assets/js/245.fdcca161.js"><link rel="prefetch" href="/assets/js/246.c83c6714.js"><link rel="prefetch" href="/assets/js/247.6677979b.js"><link rel="prefetch" href="/assets/js/248.97ea5089.js"><link rel="prefetch" href="/assets/js/249.d7170cdf.js"><link rel="prefetch" href="/assets/js/25.b67b3873.js"><link rel="prefetch" href="/assets/js/250.8adf3d86.js"><link rel="prefetch" href="/assets/js/251.86300af7.js"><link rel="prefetch" href="/assets/js/252.0e3ede05.js"><link rel="prefetch" href="/assets/js/253.586d912a.js"><link rel="prefetch" href="/assets/js/254.f521f0b4.js"><link rel="prefetch" href="/assets/js/255.0c8cdb1a.js"><link rel="prefetch" href="/assets/js/256.ec7f9c17.js"><link rel="prefetch" href="/assets/js/257.6dc36fca.js"><link rel="prefetch" href="/assets/js/258.9930d469.js"><link rel="prefetch" href="/assets/js/259.bdc389e2.js"><link rel="prefetch" href="/assets/js/26.d41155d3.js"><link rel="prefetch" href="/assets/js/260.7244b3ab.js"><link rel="prefetch" href="/assets/js/261.a0afac4b.js"><link rel="prefetch" href="/assets/js/262.431d6a82.js"><link rel="prefetch" href="/assets/js/263.c0899c3e.js"><link rel="prefetch" href="/assets/js/264.64a2a420.js"><link rel="prefetch" href="/assets/js/265.b0cad44b.js"><link rel="prefetch" href="/assets/js/266.21b77a2f.js"><link rel="prefetch" href="/assets/js/27.3c4a072d.js"><link rel="prefetch" href="/assets/js/28.4e74f69f.js"><link rel="prefetch" href="/assets/js/29.14f28039.js"><link rel="prefetch" href="/assets/js/3.2f237a9d.js"><link rel="prefetch" href="/assets/js/30.36410792.js"><link rel="prefetch" href="/assets/js/31.6ffd719e.js"><link rel="prefetch" href="/assets/js/32.bfd5c2e9.js"><link rel="prefetch" href="/assets/js/33.16929d80.js"><link rel="prefetch" href="/assets/js/34.361a9575.js"><link rel="prefetch" href="/assets/js/35.1c66b905.js"><link rel="prefetch" href="/assets/js/36.53256ba6.js"><link rel="prefetch" href="/assets/js/37.da2558ed.js"><link rel="prefetch" href="/assets/js/38.30d9e621.js"><link rel="prefetch" href="/assets/js/39.4818defd.js"><link rel="prefetch" href="/assets/js/4.7d5f245c.js"><link rel="prefetch" href="/assets/js/40.636eea27.js"><link rel="prefetch" href="/assets/js/41.0018ba6b.js"><link rel="prefetch" href="/assets/js/42.6ecc2862.js"><link rel="prefetch" href="/assets/js/43.58a75ee3.js"><link rel="prefetch" href="/assets/js/44.74a32a06.js"><link rel="prefetch" href="/assets/js/45.03250a20.js"><link rel="prefetch" href="/assets/js/46.52f68306.js"><link rel="prefetch" href="/assets/js/47.36e85e4f.js"><link rel="prefetch" href="/assets/js/48.49d57bca.js"><link rel="prefetch" href="/assets/js/49.b38b2ad5.js"><link rel="prefetch" href="/assets/js/5.d87988f8.js"><link rel="prefetch" href="/assets/js/50.56cc433e.js"><link rel="prefetch" href="/assets/js/51.c40a0825.js"><link rel="prefetch" href="/assets/js/52.63567257.js"><link rel="prefetch" href="/assets/js/53.3e42ed99.js"><link rel="prefetch" href="/assets/js/54.2761720e.js"><link rel="prefetch" href="/assets/js/55.4cb6db86.js"><link rel="prefetch" href="/assets/js/56.469a92f3.js"><link rel="prefetch" href="/assets/js/57.46afff20.js"><link rel="prefetch" href="/assets/js/58.7ef30381.js"><link rel="prefetch" href="/assets/js/59.744cb435.js"><link rel="prefetch" href="/assets/js/6.3a554393.js"><link rel="prefetch" href="/assets/js/60.094ab0a3.js"><link rel="prefetch" href="/assets/js/61.119e8b2e.js"><link rel="prefetch" href="/assets/js/62.565108d9.js"><link rel="prefetch" href="/assets/js/63.4c7edb02.js"><link rel="prefetch" href="/assets/js/65.42f707a8.js"><link rel="prefetch" href="/assets/js/66.c98dc6b7.js"><link rel="prefetch" href="/assets/js/67.ba6a3acd.js"><link rel="prefetch" href="/assets/js/68.a02a3b0b.js"><link rel="prefetch" href="/assets/js/69.cd233ec0.js"><link rel="prefetch" href="/assets/js/7.bab1dbf2.js"><link rel="prefetch" href="/assets/js/70.f1295eda.js"><link rel="prefetch" href="/assets/js/71.e1d95891.js"><link rel="prefetch" href="/assets/js/72.f5c3f64f.js"><link rel="prefetch" href="/assets/js/73.9d99f345.js"><link rel="prefetch" href="/assets/js/74.ad8f1d8c.js"><link rel="prefetch" href="/assets/js/75.c9fb45f8.js"><link rel="prefetch" href="/assets/js/76.b1d611d5.js"><link rel="prefetch" href="/assets/js/77.a04577e3.js"><link rel="prefetch" href="/assets/js/78.9ba11b90.js"><link rel="prefetch" href="/assets/js/79.420221c7.js"><link rel="prefetch" href="/assets/js/8.889a2b8d.js"><link rel="prefetch" href="/assets/js/80.9ec1d712.js"><link rel="prefetch" href="/assets/js/81.ecb47b58.js"><link rel="prefetch" href="/assets/js/82.778e423a.js"><link rel="prefetch" href="/assets/js/83.2b8384d4.js"><link rel="prefetch" href="/assets/js/84.cabc5b04.js"><link rel="prefetch" href="/assets/js/85.a094bd7c.js"><link rel="prefetch" href="/assets/js/86.cc9676aa.js"><link rel="prefetch" href="/assets/js/87.8a5e2ad5.js"><link rel="prefetch" href="/assets/js/88.35140b15.js"><link rel="prefetch" href="/assets/js/89.333e2b0b.js"><link rel="prefetch" href="/assets/js/9.b81dc625.js"><link rel="prefetch" href="/assets/js/90.2faba253.js"><link rel="prefetch" href="/assets/js/91.29ab2e40.js"><link rel="prefetch" href="/assets/js/92.8fa6f536.js"><link rel="prefetch" href="/assets/js/93.15279ab5.js"><link rel="prefetch" href="/assets/js/94.b576dde8.js"><link rel="prefetch" href="/assets/js/95.00c825c5.js"><link rel="prefetch" href="/assets/js/96.cb4857a8.js"><link rel="prefetch" href="/assets/js/97.7fd4177a.js"><link rel="prefetch" href="/assets/js/98.166528c5.js"><link rel="prefetch" href="/assets/js/99.4385d414.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3f949b7f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://open.weixin.qq.com/qr/code?username=a_javaboy" alt="江南一点雨" class="logo"> <span class="site-name can-hide">江南一点雨</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="http://www.javaboy.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  国际站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="http://www.itboyhub.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  国内站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="http://www.javaboy.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  国际站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="http://www.itboyhub.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  国内站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/ssm/" class="sidebar-heading clickable"><span>SSM</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable open"><span>Maven</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ssm/maven/info.html" class="sidebar-link">Maven 介绍</a></li><li><a href="/ssm/maven/install.html" class="sidebar-link">Maven 安装</a></li><li><a href="/ssm/maven/config.html" class="sidebar-link">Maven 配置</a></li><li><a href="/ssm/maven/maven.html" class="sidebar-link">Maven 常用命令</a></li><li><a href="/ssm/maven/idea.html" class="sidebar-link">IDEA 中使用 Maven</a></li><li><a href="/ssm/maven/dependency.html" class="sidebar-link">Maven 依赖管理</a></li><li><a href="/ssm/maven/nexus.html" class="sidebar-link">Maven 私服</a></li><li><a href="/ssm/maven/pom.html" class="sidebar-link">聚合工程</a></li><li><a href="/ssm/maven/download.html" class="sidebar-link">教程下载</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable"><span>Spring</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable"><span>SpringMVC</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable"><span>MyBatis</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable"><span>Spring 源码</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable"><span>SpringMVC 进阶</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable"><span>WebFlux</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/springboot/" class="sidebar-heading clickable"><span>SpringBoot</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable open"><span>基本配置</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/springboot/java-ssm.html" class="sidebar-link">纯 Java 搭建 SSM 项目</a></li><li><a href="/springboot/create.html" class="sidebar-link">三种创建方法</a></li><li><a href="/springboot/parent.html" class="sidebar-link">理解项目中的 parent</a></li><li><a href="/springboot/application.properties.html" class="sidebar-link">理解 application.properties</a></li><li><a href="/springboot/yaml.html" class="sidebar-link">yaml 配置</a></li><li><a href="/springboot/starter.html" class="sidebar-link">自定义 starter</a></li><li><a href="/springboot/conditional.html" class="sidebar-link">理解自动化配置原理</a></li><li><a href="/springboot/https.html" class="sidebar-link">配置 Https</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>整合视图层</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>Web开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>数据持久化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>整合 Redis</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>RESTful</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>安全管理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>其他</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>面试题</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/oauth2/" class="sidebar-heading clickable router-link-active open"><span>OAuth2</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/oauth2/oauth2-info.html" class="sidebar-link">OAuth2 简介</a></li><li><a href="/oauth2/oauth2_authorization_code.html" class="sidebar-link">授权码模式</a></li><li><a href="/oauth2/oauth2-password-implicit.html" class="sidebar-link">四种认证模式</a></li><li><a href="/oauth2/oauth2-redis.html" class="sidebar-link">引入 Redis</a></li><li><a href="/oauth2/oauth2-jwt.html" aria-current="page" class="active sidebar-link">引入 JWT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_1-无状态登录" class="sidebar-link">1. 无状态登录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_1-1-什么是有状态" class="sidebar-link">1.1 什么是有状态</a></li><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_1-2-什么是无状态" class="sidebar-link">1.2 什么是无状态</a></li><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_1-3-如何实现无状态" class="sidebar-link">1.3 如何实现无状态</a></li><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_1-4-jwt" class="sidebar-link">1.4 JWT</a></li><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_1-5-jwt-存在的问题" class="sidebar-link">1.5 JWT 存在的问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_2-oauth2-中的问题" class="sidebar-link">2.OAuth2 中的问题</a></li><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_3-改造方案" class="sidebar-link">3.改造方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_3-1-授权服务器改造" class="sidebar-link">3.1 授权服务器改造</a></li><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_3-2-资源服务器改造" class="sidebar-link">3.2 资源服务器改造</a></li></ul></li><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_4-测试" class="sidebar-link">4.测试</a></li><li class="sidebar-sub-header"><a href="/oauth2/oauth2-jwt.html#_5-原理" class="sidebar-link">5.原理</a></li></ul></li><li><a href="/oauth2/spring-cloud-oauth2.html" class="sidebar-link">微服务安全管理思路</a></li><li><a href="/oauth2/oauth2-sso.html" class="sidebar-link">单点登录</a></li><li><a href="/oauth2/github-oauth2.html" class="sidebar-link">接入 GitHub 第三方登录</a></li><li><a href="/oauth2/custom-token-info.html" class="sidebar-link">自定义返回的 Token 信息</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/springsecurity/" class="sidebar-heading clickable"><span>SpringSecurity</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/springsecurity/spring-security-guide.html" class="sidebar-link">Spring Security 简介</a></li><li><a href="/springsecurity/spring-security-form-login.html" class="sidebar-link">入门 Spring Security</a></li><li><a href="/springsecurity/spring-security-custom-formlogin.html" class="sidebar-link">定制表单登录</a></li><li><a href="/springsecurity/spring-security-json.html" class="sidebar-link">使用 JSON 交互</a></li><li><a href="/springsecurity/spring-security-authorization.html" class="sidebar-link">授权操作</a></li><li><a href="/springsecurity/spring-security-JdbcUserDetailsManager.html" class="sidebar-link">将用户数据存入数据库</a></li><li><a href="/springsecurity/springsecurity-springdatajpa.html" class="sidebar-link">Spring Data Jpa 做持久化</a></li><li><a href="/springsecurity/rememberme.html" class="sidebar-link">自动登录功能</a></li><li><a href="/springsecurity/rememberme-advance.html" class="sidebar-link">自动登录的安全风险</a></li><li><a href="/springsecurity/spring-security-vs-shiro.html" class="sidebar-link">Spring Security Vs Shiro</a></li><li><a href="/springsecurity/custom-authentication.html" class="sidebar-link">自定义认证逻辑(高级玩法)</a></li><li><a href="/springsecurity/details.html" class="sidebar-link">快速查看登录用户 IP</a></li><li><a href="/springsecurity/session-management.html" class="sidebar-link">自动踢掉前一个登录用户</a></li><li><a href="/springsecurity/springboot-vue-session-management.html" class="sidebar-link">Spring Boot + Vue 踢掉已登录用户</a></li><li><a href="/springsecurity/springsecurity-stricthttpfirewall.html" class="sidebar-link">HttpFirewall</a></li><li><a href="/springsecurity/springsecurity-sfa.html" class="sidebar-link">防御会话固定攻击</a></li><li><a href="/springsecurity/springsecurity-spring-session.html" class="sidebar-link">集群化环境处理 session 共享</a></li><li><a href="/springsecurity/springsecurity-csrf.html" class="sidebar-link">防御 CSRF 攻击</a></li><li><a href="/springsecurity/springsecurity-csrf-sourcecode.html" class="sidebar-link">CSRF 防御源码</a></li><li><a href="/springsecurity/springsecurity-passwordencoder.html" class="sidebar-link">密码加密的两种姿势</a></li><li><a href="/springsecurity/springsecurity-study.html" class="sidebar-link">Spring Security 要怎么学</a></li><li><a href="/springsecurity/springsecurity-ignoring.html" class="sidebar-link">两种资源放行策略</a></li><li><a href="/springsecurity/springsecurity-cas.html" class="sidebar-link">CAS 单点登录</a></li><li><a href="/springsecurity/springsecurity-casserver.html" class="sidebar-link">配置 CAS-Server</a></li><li><a href="/springsecurity/springsecurity-cas-mysql.html" class="sidebar-link">CAS 对接数据库</a></li><li><a href="/springsecurity/cas-login-page.html" class="sidebar-link">CAS 自定义登录页面</a></li><li><a href="/springsecurity/swagger-springsecurity.html" class="sidebar-link">在 Swagger 请求头中携带 Token</a></li><li><a href="/springsecurity/cors-springsecurity.html" class="sidebar-link">三种跨域场景总结</a></li><li><a href="/springsecurity/http-springsecurity.html" class="sidebar-link">HTTP 认证</a></li><li><a href="/springsecurity/authorize-springsecurity.html" class="sidebar-link">四种权限控制方式</a></li><li><a href="/springsecurity/passwordencoder.html" class="sidebar-link">多种加密方案共存</a></li><li><a href="/springsecurity/objectpostprocess.html" class="sidebar-link">ObjectPostProcessor</a></li><li><a href="/springsecurity/httpsecurity-and.html" class="sidebar-link">配置中的 and</a></li><li><a href="/springsecurity/springsecurity-exception.html" class="sidebar-link">异常处理机制</a></li><li><a href="/springsecurity/spring-security-securitycontext.html" class="sidebar-link">SecurityContext</a></li><li><a href="/springsecurity/springsecurity-login.html" class="sidebar-link">登录流程分析</a></li><li><a href="/springsecurity/springsecurity-vue-token.html" class="sidebar-link">文件上传携带令牌</a></li><li><a href="/springsecurity/spring-security-update-info.html" class="sidebar-link">动态更新已登录用户信息</a></li><li><a href="/springsecurity/spring-security-json-2.html" class="sidebar-link">使用 JSON 格式登录</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/redis/" class="sidebar-heading clickable"><span>Redis</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/redis/linux-redis.html" class="sidebar-link">Linux 上安装 Redis</a></li><li><a href="/redis/datatype.html" class="sidebar-link">Redis 中的五种数据类型简介</a></li><li><a href="/redis/string.html" class="sidebar-link">Redis 字符串 STRING 介绍</a></li><li><a href="/redis/string-bit.html" class="sidebar-link">BIT 相关命令</a></li><li><a href="/redis/list-set.html" class="sidebar-link">Redis 列表与集合</a></li><li><a href="/redis/hash-zset.html" class="sidebar-link">Redis 散列与有序集合</a></li><li><a href="/redis/pub-sub.html" class="sidebar-link">Redis 中的发布订阅和事务</a></li><li><a href="/redis/rdb.html" class="sidebar-link">Redis 快照持久化</a></li><li><a href="/redis/aof.html" class="sidebar-link">Redis 之 AOF 持久化</a></li><li><a href="/redis/master-slave-1.html" class="sidebar-link">Redis 主从复制(一)</a></li><li><a href="/redis/master-slave-2.html" class="sidebar-link">Redis 主从复制(二)</a></li><li><a href="/redis/cluster.html" class="sidebar-link">Redis 集群搭建</a></li><li><a href="/redis/jedis.html" class="sidebar-link">Jedis 使用</a></li><li><a href="/redis/springdata-redis.html" class="sidebar-link">Spring Data Redis 使用</a></li><li><a href="/redis/guide.html" class="sidebar-link">教程下载</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/docker/" class="sidebar-heading clickable"><span>Docker</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/docker/install.html" class="sidebar-link">入门及安装</a></li><li><a href="/docker/container-basic.html" class="sidebar-link">容器基本操作</a></li><li><a href="/docker/container-advanced.html" class="sidebar-link">容器高级操作</a></li><li><a href="/docker/images.html" class="sidebar-link">镜像基本操作</a></li><li><a href="/docker/dockerhub-newwork.html" class="sidebar-link">DockerHub 与容器网络</a></li><li><a href="/docker/data.html" class="sidebar-link">数据卷操作</a></li><li><a href="/docker/link.html" class="sidebar-link">容器连接</a></li><li><a href="/docker/container-arrangement.html" class="sidebar-link">容器编排入门</a></li><li><a href="/docker/mysql.html" class="sidebar-link">Docker 搭建 MySQL 主从复制</a></li><li><a href="/docker/download.html" class="sidebar-link">教程下载</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/mongodb/" class="sidebar-heading clickable"><span>MongoDB</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/mongodb/linux-install-mongodb.html" class="sidebar-link">Linux 上安装 MongoDB</a></li><li><a href="/mongodb/basic-operations.html" class="sidebar-link">基本操作</a></li><li><a href="/mongodb/data-types.html" class="sidebar-link">数据类型</a></li><li><a href="/mongodb/documents-update.html" class="sidebar-link">文档更新操作</a></li><li><a href="/mongodb/documents-query.html" class="sidebar-link">文档查询操作(一)</a></li><li><a href="/mongodb/documents-query-2.html" class="sidebar-link">文档查询操作(二)</a></li><li><a href="/mongodb/query-planner.html" class="sidebar-link">查看执行计划</a></li><li><a href="/mongodb/index-basic.html" class="sidebar-link">初识索引</a></li><li><a href="/mongodb/index-types.html" class="sidebar-link">各种类型的索引</a></li><li><a href="/mongodb/collections.html" class="sidebar-link">固定集合</a></li><li><a href="/mongodb/pipelines.html" class="sidebar-link">管道操作符(一)</a></li><li><a href="/mongodb/pipelines-2.html" class="sidebar-link">管道操作符(二)</a></li><li><a href="/mongodb/in-mapreduce.html" class="sidebar-link">MapReduce 使用</a></li><li><a href="/mongodb/replicaset-install.html" class="sidebar-link">副本集搭建</a></li><li><a href="/mongodb/replicaset-settings.html" class="sidebar-link">副本集配置</a></li><li><a href="/mongodb/replicaset-details.html" class="sidebar-link">副本集其他细节</a></li><li><a href="/mongodb/shard.html" class="sidebar-link">初识分片</a></li><li><a href="/mongodb/in-java.html" class="sidebar-link">Java 操作 MongoDB</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/mysql/" class="sidebar-heading clickable"><span>MySQL</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/mysql/mysql-read-write.html" class="sidebar-link">MySQL  读写分离环境搭建(一)</a></li><li><a href="/mysql/mysql-read-write-2.html" class="sidebar-link">MySQL  读写分离环境搭建(二)</a></li><li><a href="/mysql/mysql.html" class="sidebar-link">MySQL 只能做小项目？</a></li><li><a href="/mysql/mysql-sharding.html" class="sidebar-link">初识数据库切分</a></li><li><a href="/mysql/middleware.html" class="sidebar-link">What？Tomcat 竟然也算中间件？</a></li><li><a href="/mysql/mycat-install.html" class="sidebar-link">分布式数据库中间件 MyCat</a></li><li><a href="/mysql/mycat-rule.html" class="sidebar-link">数据库分片规则</a></li><li><a href="/mysql/mycat-id-autoincrement.html" class="sidebar-link">分布式数据库主键全局自增</a></li><li><a href="/mysql/mysql-high-performance.html" class="sidebar-link">给数据库减负的八个思路</a></li><li><a href="/mysql/mybatis-key-generated.html" class="sidebar-link">MyBatis 中主键回填</a></li><li><a href="/mysql/mybatis-@param.html" class="sidebar-link">MyBatis 中 @Param 注解使用场景</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/git/" class="sidebar-heading clickable"><span>Git</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/git/install.html" class="sidebar-link">Git 概述</a></li><li><a href="/git/basic.html" class="sidebar-link">Git 基本操作</a></li><li><a href="/git/delete.html" class="sidebar-link">Git 中的各种后悔药</a></li><li><a href="/git/branch.html" class="sidebar-link">Git 分支管理</a></li><li><a href="/git/remote.html" class="sidebar-link">Git 关联远程仓库</a></li><li><a href="/git/tag.html" class="sidebar-link">Git 标签管理</a></li><li><a href="/git/stash.html" class="sidebar-link">Git 工作区储藏</a></li><li><a href="/git/resources.html" class="sidebar-link">Git 学习资料</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>[TOC]</p> <p>本文是我们 OAuth2 系列的第五篇，通过前面四篇文章相信大家对于 OAuth2 中的各种授权登录流程已经轻车熟路了。</p> <p>前面的文章松哥侧重于和大家理清楚 OAuth2 的登录流程，对于一些登录细节则没有去深究，接下来松哥会和大家把这些案例一一进行晚上。</p> <p>本文依然是在前面案例的基础上完成，所以还是强烈建议小伙伴们阅读本系列前面的文章：</p> <ol><li><a href="https://mp.weixin.qq.com/s/AELXf1nmpWbYE3NINpLDRg" target="_blank" rel="noopener noreferrer">做微服务绕不过的 OAuth2，松哥也来和大家扯一扯<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mp.weixin.qq.com/s/GXMQI59U6uzmS-C0WQ5iUw" target="_blank" rel="noopener noreferrer">这个案例写出来，还怕跟面试官扯不明白 OAuth2 登录流程？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mp.weixin.qq.com/s/33Oxu6YMjwco3WRE07_IiQ" target="_blank" rel="noopener noreferrer">死磕 OAuth2，教练我要学全套的！<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mp.weixin.qq.com/s/cGopy8hDPtkn8Q7HUYabbA" target="_blank" rel="noopener noreferrer">OAuth2 令牌还能存入 Redis ？越玩越溜！<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <p>今天松哥主要和大家分享如何把 OAuth2 和 JWT 套在一起玩！</p> <p>传统的通过 session 来记录用户认证信息的方式我们可以理解为这是一种有状态登录，而 JWT 则代表了一种无状态登录。<strong>无状态登录天然的具备单点登录能力，所以这个技术组合小伙伴们还是很有必要认真学习下。</strong> 可能有小伙伴对这个概念还不太熟悉，我这里就先来科普一下有状态登录和无状态登录。</p> <h2 id="_1-无状态登录"><a href="#_1-无状态登录" class="header-anchor">#</a> 1. 无状态登录</h2> <h3 id="_1-1-什么是有状态"><a href="#_1-1-什么是有状态" class="header-anchor">#</a> 1.1 什么是有状态</h3> <p>有状态服务，即服务端需要记录每次会话的客户端信息，从而识别客户端身份，根据用户身份进行请求的处理，典型的设计如 Tomcat 中的 Session。例如登录：用户登录后，我们把用户的信息保存在服务端 session 中，并且给用户一个 cookie 值，记录对应的 session，然后下次请求，用户携带 cookie 值来（这一步有浏览器自动完成），我们就能识别到对应 session，从而找到用户的信息。这种方式目前来看最方便，但是也有一些缺陷，如下：</p> <ul><li>服务端保存大量数据，增加服务端压力</li> <li>服务端保存用户状态，不支持集群化部署</li></ul> <h3 id="_1-2-什么是无状态"><a href="#_1-2-什么是无状态" class="header-anchor">#</a> 1.2 什么是无状态</h3> <p>微服务集群中的每个服务，对外提供的都使用 RESTful 风格的接口。而 RESTful 风格的一个最重要的规范就是：服务的无状态性，即：</p> <ul><li>服务端不保存任何客户端请求者信息</li> <li>客户端的每次请求必须具备自描述信息，通过这些信息识别客户端身份</li></ul> <p>那么这种无状态性有哪些好处呢？</p> <ul><li>客户端请求不依赖服务端的信息，多次请求不需要必须访问到同一台服务器</li> <li>服务端的集群和状态对客户端透明</li> <li>服务端可以任意的迁移和伸缩（可以方便的进行集群化部署）</li> <li>减小服务端存储压力</li></ul> <h3 id="_1-3-如何实现无状态"><a href="#_1-3-如何实现无状态" class="header-anchor">#</a> 1.3 如何实现无状态</h3> <p>无状态登录的流程：</p> <ul><li>首先客户端发送账户名/密码到服务端进行认证</li> <li>认证通过后，服务端将用户信息加密并且编码成一个 token，返回给客户端</li> <li>以后客户端每次发送请求，都需要携带认证的 token</li> <li>服务端对客户端发送来的 token 进行解密，判断是否有效，并且获取用户登录信息</li></ul> <h3 id="_1-4-jwt"><a href="#_1-4-jwt" class="header-anchor">#</a> 1.4 JWT</h3> <h4 id="_1-4-1-简介"><a href="#_1-4-1-简介" class="header-anchor">#</a> 1.4.1 简介</h4> <p>JWT，全称是 Json Web Token ， 是一种 JSON 风格的轻量级的授权和身份认证规范，可实现无状态、分布式的 Web 应用授权：</p> <p><img src="http://img.itboyhub.com/2020/04/oauth-5-1.png" alt=""></p> <p>JWT 作为一种规范，并没有和某一种语言绑定在一起，常用的 Java 实现是 GitHub 上的开源项目 jjwt，地址如下：<code>https://github.com/jwtk/jjwt</code></p> <h4 id="_1-4-2-jwt-数据格式"><a href="#_1-4-2-jwt-数据格式" class="header-anchor">#</a> 1.4.2 JWT 数据格式</h4> <p>JWT 包含三部分数据：</p> <p>1.Header：头部，通常头部有两部分信息：</p> <ul><li>声明类型，这里是JWT</li> <li>加密算法，自定义</li></ul> <p>我们会对头部进行 Base64Url 编码（可解码），得到第一部分数据。</p> <p>2.Payload：载荷，就是有效数据，在官方文档中(RFC7519)，这里给了 7 个示例信息：</p> <ul><li>iss (issuer)：表示签发人</li> <li>exp (expiration time)：表示token过期时间</li> <li>sub (subject)：主题</li> <li>aud (audience)：受众</li> <li>nbf (Not Before)：生效时间</li> <li>iat (Issued At)：签发时间</li> <li>jti (JWT ID)：编号</li></ul> <p>这部分也会采用 Base64Url 编码，得到第二部分数据。</p> <p>3.Signature：签名，是整个数据的认证信息。一般根据前两步的数据，再加上服务的的密钥 secret（密钥保存在服务端，不能泄露给客户端），通过 Header 中配置的加密算法生成。用于验证整个数据完整和可靠性。</p> <p>生成的数据格式如下图：</p> <p><img src="http://img.itboyhub.com/2020/04/oauth-5-2.png" alt=""></p> <p>注意，这里的数据通过 <code>.</code> 隔开成了三部分，分别对应前面提到的三部分，另外，这里数据是不换行的，图片换行只是为了展示方便而已。</p> <h4 id="_1-4-3-jwt-交互流程"><a href="#_1-4-3-jwt-交互流程" class="header-anchor">#</a> 1.4.3 JWT 交互流程</h4> <p>流程图：</p> <p><img src="http://img.itboyhub.com/2020/04/oauth-5-3.png" alt=""></p> <p>步骤翻译：</p> <ol><li>应用程序或客户端向授权服务器请求授权</li> <li>获取到授权后，授权服务器会向应用程序返回访问令牌</li> <li>应用程序使用访问令牌来访问受保护资源（如API）</li></ol> <p>因为 JWT 签发的 token 中已经包含了用户的身份信息，并且每次请求都会携带，这样服务的就无需保存用户信息，甚至无需去数据库查询，这样就符合了 RESTful 的无状态规范。</p> <h3 id="_1-5-jwt-存在的问题"><a href="#_1-5-jwt-存在的问题" class="header-anchor">#</a> 1.5 JWT 存在的问题</h3> <p>说了这么多，JWT 也不是天衣无缝，由客户端维护登录状态带来的一些问题在这里依然存在，举例如下：</p> <ol><li>续签问题，这是被很多人诟病的问题之一，传统的 cookie+session 的方案天然的支持续签，但是 jwt 由于服务端不保存用户状态，因此很难完美解决续签问题，如果引入 redis，虽然可以解决问题，但是 jwt 也变得不伦不类了。</li> <li>注销问题，由于服务端不再保存用户信息，所以一般可以通过修改 secret 来实现注销，服务端 secret 修改后，已经颁发的未过期的 token 就会认证失败，进而实现注销，不过毕竟没有传统的注销方便。</li> <li>密码重置，密码重置后，原本的 token 依然可以访问系统，这时候也需要强制修改 secret。</li> <li>基于第 2 点和第 3 点，一般建议不同用户取不同 secret。</li></ol> <h2 id="_2-oauth2-中的问题"><a href="#_2-oauth2-中的问题" class="header-anchor">#</a> 2.OAuth2 中的问题</h2> <p>在<a href="https://mp.weixin.qq.com/s/GXMQI59U6uzmS-C0WQ5iUw" target="_blank" rel="noopener noreferrer">前面的文章中<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，授权服务器派发了 access_token 之后，客户端拿着 access_token 去请求资源服务器，资源服务器要去校验 access_token 的真伪，所以我们在资源服务器上配置了 RemoteTokenServices，让资源服务器做远程校验：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token class-name">RemoteTokenServices</span> <span class="token function">tokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RemoteTokenServices</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemoteTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">setCheckTokenEndpointUrl</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/oauth/check_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">setClientId</span><span class="token punctuation">(</span><span class="token string">&quot;javaboy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">setClientSecret</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> services<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在高并发环境下这样的校验方式显然是有问题的，如果结合 JWT，用户的所有信息都保存在 JWT 中，这样就可以有效的解决上面的问题。</p> <h2 id="_3-改造方案"><a href="#_3-改造方案" class="header-anchor">#</a> 3.改造方案</h2> <h3 id="_3-1-授权服务器改造"><a href="#_3-1-授权服务器改造" class="header-anchor">#</a> 3.1 授权服务器改造</h3> <p>首先我们来看对授权服务器的改造，我们来修改 AccessTokenConfig 类，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessTokenConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> SIGNING_KEY <span class="token operator">=</span> <span class="token string">&quot;javaboy&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>SIGNING_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的改造主要是两方面：</p> <ol><li>TokenStore 我们使用 JwtTokenStore 这个实例。之前我们将 access_token 无论是存储在内存中，还是存储在 Redis 中，都是要存下来的，客户端将 access_token 发来之后，我们还要校验看对不对。但是如果使用了 JWT，access_token 实际上就不用存储了（无状态登录，服务端不需要保存信息），因为用户的所有信息都在 jwt 里边，所以这里配置的 JwtTokenStore 本质上并不是做存储。</li> <li>另外我们还提供了一个 JwtAccessTokenConverter，这个 JwtAccessTokenConverter 可以实现将用户信息和 JWT 进行转换（将用户信息转为 jwt 字符串，或者从 jwt 字符串提取出用户信息）。</li> <li>另外，在 JWT 字符串生成的时候，我们需要一个签名，这个签名需要自己保存好。</li></ol> <p>这里 JWT 默认生成的用户信息主要是用户角色、用户名等，如果我们希望在生成的 JWT 上面添加额外的信息，可以按照如下方式添加：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomAdditionalInformation</span> <span class="token keyword">implements</span> <span class="token class-name">TokenEnhancer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AccessToken</span> accessToken<span class="token punctuation">,</span> <span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> info <span class="token operator">=</span> accessToken<span class="token punctuation">.</span><span class="token function">getAdditionalInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;江南一点雨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">)</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAdditionalInformation</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>自定义类 CustomAdditionalInformation 实现 TokenEnhancer 接口，并实现接口中的 enhance 方法。enhance 方法中的 OAuth2AccessToken 参数就是已经生成的 access_token 信息，我们可以从 OAuth2AccessToken 中取出已经生成的额外信息，然后在此基础上追加自己的信息。</p> <p><strong>需要提醒一句，其实我们配置的 JwtAccessTokenConverter 也是 TokenEnhancer 的一个实例</strong></p> <p>配置完成之后，我们还需要在 AuthorizationServer 中修改 AuthorizationServerTokenServices 实例，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">JwtAccessTokenConverter</span> jwtAccessTokenConverter<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">CustomAdditionalInformation</span> customAdditionalInformation<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token class-name">AuthorizationServerTokenServices</span> <span class="token function">tokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DefaultTokenServices</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">setClientDetailsService</span><span class="token punctuation">(</span><span class="token function">clientDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">setSupportRefreshToken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">setTokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TokenEnhancerChain</span> tokenEnhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tokenEnhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">,</span> customAdditionalInformation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">setTokenEnhancer</span><span class="token punctuation">(</span>tokenEnhancerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> services<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里主要是是在 DefaultTokenServices 中配置 TokenEnhancer，将之前的 JwtAccessTokenConverter 和 CustomAdditionalInformation 两个实例注入进来即可。</p> <p>如此之后，我们的 auth-server 就算是配置成功了。</p> <h3 id="_3-2-资源服务器改造"><a href="#_3-2-资源服务器改造" class="header-anchor">#</a> 3.2 资源服务器改造</h3> <p>接下来我们还需要对资源服务器进行改造，也就是 user-server，我们将 auth-server 中的 AccessTokenConfig 类拷贝到 user-server 中，然后在资源服务器配置中不再配置远程校验地址，而是配置一个 TokenStore 即可：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableResourceServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ResourceServerSecurityConfigurer</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        resources<span class="token punctuation">.</span><span class="token function">resourceId</span><span class="token punctuation">(</span><span class="token string">&quot;res1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/admin/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里配置好之后，会自动调用 JwtAccessTokenConverter 将 jwt 解析出来，jwt 里边就包含了用户的基本信息，所以就不用远程校验 access_token 了。</p> <h2 id="_4-测试"><a href="#_4-测试" class="header-anchor">#</a> 4.测试</h2> <p>OK，上面配置完成后，我们就可以启动 auth-server、user-server 进行测试，这里为了测试方便，我配置了 password 模式来测试（参考<a href="https://mp.weixin.qq.com/s/33Oxu6YMjwco3WRE07_IiQ" target="_blank" rel="noopener noreferrer">死磕 OAuth2，教练我要学全套的！<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</p> <p>首先我们请求 auth-server 获取 token，如下：</p> <p><img src="http://img.itboyhub.com/2020/04/oauth-5-4.png" alt=""></p> <p>可以看到，jwt 的字符串还是挺长的，另外返回的数据中也有我们自定义的信息。根据本文第一小节的介绍，小伙伴们可以使用一些在线的 Base64 工具自行解码 jwt 字符串的前两部分，当然也可以通过 check_token 接口来解析：</p> <p><img src="http://img.itboyhub.com/2020/04/oauth-5-5.png" alt=""></p> <p>解析后就可以看到 jwt 中保存的用户详细信息了。</p> <p>拿到 access_token 之后，我们就可以去访问 user-server 中的资源了，访问方式跟之前的一样，请求头中传入 access_token 即可：</p> <p><img src="http://img.itboyhub.com/2020/04/oauth-5-6.png" alt=""></p> <p>如此之后，我们就成功的将 OAuth2 和 Jwt 结合起来了。</p> <h2 id="_5-原理"><a href="#_5-原理" class="header-anchor">#</a> 5.原理</h2> <p>那么普通的 access_token 到底是怎么变为 jwt 的？jwt 和认证信息又是如何自动转换的？松哥也来和大家扯一扯。</p> <p>首先我们知道，access_token 的生成，默认是在 DefaultTokenServices#createAccessToken 方法中的，我们来看下 createAccessToken 方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">createAccessToken</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">OAuth2RefreshToken</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">DefaultOAuth2AccessToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> validitySeconds <span class="token operator">=</span> <span class="token function">getAccessTokenValiditySeconds</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getOAuth2Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>validitySeconds <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		token<span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>validitySeconds <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	token<span class="token punctuation">.</span><span class="token function">setRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
	token<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getOAuth2Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> accessTokenEnhancer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> accessTokenEnhancer<span class="token punctuation">.</span><span class="token function">enhance</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span> <span class="token operator">:</span> token<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从这段源码中我们可以看到：</p> <ol><li>默认生成的 access_token 其实就是一个 UUID 字符串。</li> <li>getAccessTokenValiditySeconds 方法用来获取 access_token 的有效期，点进去这个方法，我们发现这个数字是从数据库中查询出来的，其实就是我们配置的 access_token 的有效期，我们配置的有效期单位是秒。</li> <li>如果设置的 access_token 有效期大于 0，则调用 setExpiration 方法设置过期时间，过期时间就是在当前时间基础上加上用户设置的过期时间，注意乘以 1000 将时间单位转为毫秒。</li> <li>接下来设置刷新 token 和授权范围 scope（刷新 token 的生成过程在 createRefreshToken 方法中，其实和 access_token 的生成过程类似）。</li> <li>最后面 return 比较关键，这里会判断有没有 accessTokenEnhancer，如果 accessTokenEnhancer 不为 null，则在 accessTokenEnhancer 中再处理一遍才返回，accessTokenEnhancer 中再处理一遍就比较关键了，就是 access_token 转为 jwt 字符串的过程。</li></ol> <p>这里的 accessTokenEnhancer 实际上是一个 TokenEnhancerChain，这个链中有一个 delegates 变量保存了我们定义的两个 TokenEnhancer（auth-server 中定义的 JwtAccessTokenConverter 和 CustomAdditionalInformation），也就是说，我们的 access_token 信息将在这两个类中进行二次处理。<strong>处理的顺序是按照集合中保存的顺序，就是先在 JwtAccessTokenConverter 中处理，后在 CustomAdditionalInformation 中处理，顺序不能乱，也意味着我们在 auth-server 中定义的时候，JwtAccessTokenConverter 和 CustomAdditionalInformation 的顺序不能写错。</strong></p> <p>无论是 JwtAccessTokenConverter 还是 CustomAdditionalInformation，它里边核心的方法都是 enhance，我们先来看 JwtAccessTokenConverter#enhance：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AccessToken</span> accessToken<span class="token punctuation">,</span> <span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">DefaultOAuth2AccessToken</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>accessToken<span class="token punctuation">.</span><span class="token function">getAdditionalInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> tokenId <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>TOKEN_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>TOKEN_ID<span class="token punctuation">,</span> tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		tokenId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> info<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>TOKEN_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	result<span class="token punctuation">.</span><span class="token function">setAdditionalInformation</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
	result<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">OAuth2RefreshToken</span> refreshToken <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getRefreshToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>refreshToken <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">DefaultOAuth2AccessToken</span> encodedRefreshToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
		encodedRefreshToken<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Refresh tokens do not expire unless explicitly of the right type</span>
		encodedRefreshToken<span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims <span class="token operator">=</span> objectMapper
					<span class="token punctuation">.</span><span class="token function">parseMap</span><span class="token punctuation">(</span><span class="token class-name">JwtHelper</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>claims<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>TOKEN_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				encodedRefreshToken<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>TOKEN_ID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> refreshTokenInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
				accessToken<span class="token punctuation">.</span><span class="token function">getAdditionalInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		refreshTokenInfo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>TOKEN_ID<span class="token punctuation">,</span> encodedRefreshToken<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		refreshTokenInfo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ACCESS_TOKEN_ID<span class="token punctuation">,</span> tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		encodedRefreshToken<span class="token punctuation">.</span><span class="token function">setAdditionalInformation</span><span class="token punctuation">(</span>refreshTokenInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">DefaultOAuth2RefreshToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultOAuth2RefreshToken</span><span class="token punctuation">(</span>
				<span class="token function">encode</span><span class="token punctuation">(</span>encodedRefreshToken<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>refreshToken <span class="token keyword">instanceof</span> <span class="token class-name">ExpiringOAuth2RefreshToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Date</span> expiration <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ExpiringOAuth2RefreshToken</span><span class="token punctuation">)</span> refreshToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			encodedRefreshToken<span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>expiration<span class="token punctuation">)</span><span class="token punctuation">;</span>
			token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultExpiringOAuth2RefreshToken</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>encodedRefreshToken<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">,</span> expiration<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		result<span class="token punctuation">.</span><span class="token function">setRefreshToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码虽然比较长，但是却很好理解：</p> <ol><li>首先构造一个 DefaultOAuth2AccessToken 对象。</li> <li>将 accessToken 中的附加信息拿出来（此时默认没有附加信息）。</li> <li>获取旧的 access_token（就是上一步 UUID 字符串），将之作为附加信息存入到 info 中（第四小节测试中，返回的 jwt 中有一个 jti，其实就是这里存入进来的）。</li> <li>将附加信息存入 result 中。</li> <li>对 result 进行编码，将编码结果作为新的 access_token，这个编码的过程就是 jwt 字符串生成的过程。</li> <li>接下来是处理刷新 token，刷新 token 如果是 jwt 字符串，则需要有一个解码操作，否则不需要，刷新 token 如果是 ExpiringOAuth2RefreshToken 的实例，表示刷新 token 已经过期，则重新生成一个，这里的逻辑比较简单，我就不啰嗦了。</li></ol> <p>最后我们再来看看这里多次出现的 encode 方法，就是 jwt 字符串编码的过程：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AccessToken</span> accessToken<span class="token punctuation">,</span> <span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">String</span> content<span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		content <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">formatMap</span><span class="token punctuation">(</span>tokenConverter<span class="token punctuation">.</span><span class="token function">convertAccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot convert access token to JSON&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">JwtHelper</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> signer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> token<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到，这里首先是把用户信息和 access_token 生成一个 JSON 字符串，然后调用 JwtHelper.encode 方法进行 jwt 编码。</p> <p>jwt 编码的过程其实也不难，松哥之前也写过相应的文章，感兴趣的小伙伴可以公众号后台回复 springboot，里边有一篇文章就是讲自动手动生成 jwt 字符串的，这里我就不赘述了。</p> <p>OK，本文和小伙伴们聊了一些 OAuth2+JWT 的问题，完成案例下载地址：<a href="https://github.com/lenve/oauth2-samples" target="_blank" rel="noopener noreferrer">https://github.com/lenve/oauth2-samples<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>如果小伙伴们觉得有用的话，记得点个在看鼓励下松哥。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/oauth2/oauth2-redis.html" class="prev">
        引入 Redis
      </a></span> <span class="next"><a href="/oauth2/spring-cloud-oauth2.html">
        微服务安全管理思路
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.93cfb041.js" defer></script><script src="/assets/js/2.afd40777.js" defer></script><script src="/assets/js/64.54bb5e4b.js" defer></script>
  </body>
</html>
