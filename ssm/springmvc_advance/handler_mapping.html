<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入 HandlerMapping | 江南一点雨</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="https://open.weixin.qq.com/qr/code?username=a_javaboy">
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.3f949b7f.css" as="style"><link rel="preload" href="/assets/js/app.93cfb041.js" as="script"><link rel="preload" href="/assets/js/2.afd40777.js" as="script"><link rel="preload" href="/assets/js/242.0491824c.js" as="script"><link rel="prefetch" href="/assets/js/10.f65a90e2.js"><link rel="prefetch" href="/assets/js/100.3bcf32ff.js"><link rel="prefetch" href="/assets/js/101.bd9ebd49.js"><link rel="prefetch" href="/assets/js/102.392f968e.js"><link rel="prefetch" href="/assets/js/103.afadf5bf.js"><link rel="prefetch" href="/assets/js/104.c8312846.js"><link rel="prefetch" href="/assets/js/105.97a4170a.js"><link rel="prefetch" href="/assets/js/106.9f0ef153.js"><link rel="prefetch" href="/assets/js/107.bb303c1b.js"><link rel="prefetch" href="/assets/js/108.45e76aae.js"><link rel="prefetch" href="/assets/js/109.7e4e3e84.js"><link rel="prefetch" href="/assets/js/11.5e8094b3.js"><link rel="prefetch" href="/assets/js/110.839e4506.js"><link rel="prefetch" href="/assets/js/111.50cc5969.js"><link rel="prefetch" href="/assets/js/112.715e408b.js"><link rel="prefetch" href="/assets/js/113.aaba78f1.js"><link rel="prefetch" href="/assets/js/114.6a025439.js"><link rel="prefetch" href="/assets/js/115.8b36028e.js"><link rel="prefetch" href="/assets/js/116.2aa7851e.js"><link rel="prefetch" href="/assets/js/117.75ea5460.js"><link rel="prefetch" href="/assets/js/118.26bc5dca.js"><link rel="prefetch" href="/assets/js/119.0f7df258.js"><link rel="prefetch" href="/assets/js/12.4f05d2f8.js"><link rel="prefetch" href="/assets/js/120.f7b3a0ed.js"><link rel="prefetch" href="/assets/js/121.cf863463.js"><link rel="prefetch" href="/assets/js/122.fa3cfbdb.js"><link rel="prefetch" href="/assets/js/123.adc5157d.js"><link rel="prefetch" href="/assets/js/124.fbe6a3bf.js"><link rel="prefetch" href="/assets/js/125.d3e4c526.js"><link rel="prefetch" href="/assets/js/126.2667f20c.js"><link rel="prefetch" href="/assets/js/127.a992245e.js"><link rel="prefetch" href="/assets/js/128.e2dc5f84.js"><link rel="prefetch" href="/assets/js/129.276d62b1.js"><link rel="prefetch" href="/assets/js/13.6be298bf.js"><link rel="prefetch" href="/assets/js/130.df0fd4f2.js"><link rel="prefetch" href="/assets/js/131.e4e2b4dd.js"><link rel="prefetch" href="/assets/js/132.42ac2755.js"><link rel="prefetch" href="/assets/js/133.4d19914d.js"><link rel="prefetch" href="/assets/js/134.eee5f7f1.js"><link rel="prefetch" href="/assets/js/135.63554b27.js"><link rel="prefetch" href="/assets/js/136.a6bc1760.js"><link rel="prefetch" href="/assets/js/137.5fc69fd8.js"><link rel="prefetch" href="/assets/js/138.de23da83.js"><link rel="prefetch" href="/assets/js/139.a1faeb31.js"><link rel="prefetch" href="/assets/js/14.815db104.js"><link rel="prefetch" href="/assets/js/140.95dbf73f.js"><link rel="prefetch" href="/assets/js/141.b4542eae.js"><link rel="prefetch" href="/assets/js/142.f9296937.js"><link rel="prefetch" href="/assets/js/143.9ea81dee.js"><link rel="prefetch" href="/assets/js/144.a423b13c.js"><link rel="prefetch" href="/assets/js/145.7da590a6.js"><link rel="prefetch" href="/assets/js/146.bca8af1b.js"><link rel="prefetch" href="/assets/js/147.0aa847b1.js"><link rel="prefetch" href="/assets/js/148.8e722bc5.js"><link rel="prefetch" href="/assets/js/149.082e9ce8.js"><link rel="prefetch" href="/assets/js/15.f278054c.js"><link rel="prefetch" href="/assets/js/150.57c0d03e.js"><link rel="prefetch" href="/assets/js/151.bfeac464.js"><link rel="prefetch" href="/assets/js/152.1ed78952.js"><link rel="prefetch" href="/assets/js/153.51ae1560.js"><link rel="prefetch" href="/assets/js/154.a6f7351f.js"><link rel="prefetch" href="/assets/js/155.8cb2b9b7.js"><link rel="prefetch" href="/assets/js/156.baf79d5d.js"><link rel="prefetch" href="/assets/js/157.6dc937e3.js"><link rel="prefetch" href="/assets/js/158.f9688b9c.js"><link rel="prefetch" href="/assets/js/159.9c2d77a9.js"><link rel="prefetch" href="/assets/js/16.345bdcfc.js"><link rel="prefetch" href="/assets/js/160.c928cf3c.js"><link rel="prefetch" href="/assets/js/161.5d3727ba.js"><link rel="prefetch" href="/assets/js/162.bb1e7f33.js"><link rel="prefetch" href="/assets/js/163.049f7d18.js"><link rel="prefetch" href="/assets/js/164.a480bd3f.js"><link rel="prefetch" href="/assets/js/165.c8f91cd5.js"><link rel="prefetch" href="/assets/js/166.f0a0e356.js"><link rel="prefetch" href="/assets/js/167.54930ff6.js"><link rel="prefetch" href="/assets/js/168.2702d69f.js"><link rel="prefetch" href="/assets/js/169.44923723.js"><link rel="prefetch" href="/assets/js/17.a076d059.js"><link rel="prefetch" href="/assets/js/170.0e2e92d4.js"><link rel="prefetch" href="/assets/js/171.e63c9b1d.js"><link rel="prefetch" href="/assets/js/172.c18ef95a.js"><link rel="prefetch" href="/assets/js/173.a78b9057.js"><link rel="prefetch" href="/assets/js/174.35a568dc.js"><link rel="prefetch" href="/assets/js/175.aaff1ff2.js"><link rel="prefetch" href="/assets/js/176.10d8a2e2.js"><link rel="prefetch" href="/assets/js/177.83ea0cb0.js"><link rel="prefetch" href="/assets/js/178.3c9de5ed.js"><link rel="prefetch" href="/assets/js/179.28e6d588.js"><link rel="prefetch" href="/assets/js/18.542b7e9d.js"><link rel="prefetch" href="/assets/js/180.6c49aa48.js"><link rel="prefetch" href="/assets/js/181.5a053633.js"><link rel="prefetch" href="/assets/js/182.b23e7d08.js"><link rel="prefetch" href="/assets/js/183.ee09403b.js"><link rel="prefetch" href="/assets/js/184.94593e4b.js"><link rel="prefetch" href="/assets/js/185.ea14675f.js"><link rel="prefetch" href="/assets/js/186.105f44fd.js"><link rel="prefetch" href="/assets/js/187.13bdebf6.js"><link rel="prefetch" href="/assets/js/188.df5be68c.js"><link rel="prefetch" href="/assets/js/189.8feb4ee4.js"><link rel="prefetch" href="/assets/js/19.741384a0.js"><link rel="prefetch" href="/assets/js/190.8c35be02.js"><link rel="prefetch" href="/assets/js/191.9bbb2940.js"><link rel="prefetch" href="/assets/js/192.77be398f.js"><link rel="prefetch" href="/assets/js/193.401d4d9e.js"><link rel="prefetch" href="/assets/js/194.ce411ee2.js"><link rel="prefetch" href="/assets/js/195.10a07ccc.js"><link rel="prefetch" href="/assets/js/196.74cbc7e7.js"><link rel="prefetch" href="/assets/js/197.5d03c5b7.js"><link rel="prefetch" href="/assets/js/198.c298c39b.js"><link rel="prefetch" href="/assets/js/199.29ec26b9.js"><link rel="prefetch" href="/assets/js/20.4c668583.js"><link rel="prefetch" href="/assets/js/200.9b042f85.js"><link rel="prefetch" href="/assets/js/201.ce4fe568.js"><link rel="prefetch" href="/assets/js/202.97cae704.js"><link rel="prefetch" href="/assets/js/203.9f870d68.js"><link rel="prefetch" href="/assets/js/204.2796778b.js"><link rel="prefetch" href="/assets/js/205.8efe9247.js"><link rel="prefetch" href="/assets/js/206.ff06ce73.js"><link rel="prefetch" href="/assets/js/207.0402326b.js"><link rel="prefetch" href="/assets/js/208.2bd6489b.js"><link rel="prefetch" href="/assets/js/209.ca24b4e7.js"><link rel="prefetch" href="/assets/js/21.aebbbd15.js"><link rel="prefetch" href="/assets/js/210.4d61626d.js"><link rel="prefetch" href="/assets/js/211.6c198d71.js"><link rel="prefetch" href="/assets/js/212.52494de3.js"><link rel="prefetch" href="/assets/js/213.43f986d0.js"><link rel="prefetch" href="/assets/js/214.3403d0f9.js"><link rel="prefetch" href="/assets/js/215.ba7b6da8.js"><link rel="prefetch" href="/assets/js/216.ecbe6232.js"><link rel="prefetch" href="/assets/js/217.70deb9f1.js"><link rel="prefetch" href="/assets/js/218.de783ea7.js"><link rel="prefetch" href="/assets/js/219.4efc57bc.js"><link rel="prefetch" href="/assets/js/22.f361a824.js"><link rel="prefetch" href="/assets/js/220.5dc860c4.js"><link rel="prefetch" href="/assets/js/221.7a3c5614.js"><link rel="prefetch" href="/assets/js/222.b5a275ab.js"><link rel="prefetch" href="/assets/js/223.a8ea0f32.js"><link rel="prefetch" href="/assets/js/224.b2f5c374.js"><link rel="prefetch" href="/assets/js/225.0ab9bbe5.js"><link rel="prefetch" href="/assets/js/226.73ddbdc1.js"><link rel="prefetch" href="/assets/js/227.a8617bac.js"><link rel="prefetch" href="/assets/js/228.184e2034.js"><link rel="prefetch" href="/assets/js/229.a7efe08d.js"><link rel="prefetch" href="/assets/js/23.a04c99fe.js"><link rel="prefetch" href="/assets/js/230.49a88e1b.js"><link rel="prefetch" href="/assets/js/231.a422f33e.js"><link rel="prefetch" href="/assets/js/232.c323a194.js"><link rel="prefetch" href="/assets/js/233.5edbdef4.js"><link rel="prefetch" href="/assets/js/234.9f0a13bb.js"><link rel="prefetch" href="/assets/js/235.54a4fc37.js"><link rel="prefetch" href="/assets/js/236.d2d69ec5.js"><link rel="prefetch" href="/assets/js/237.64f6dcea.js"><link rel="prefetch" href="/assets/js/238.61c501f3.js"><link rel="prefetch" href="/assets/js/239.a33bb2dd.js"><link rel="prefetch" href="/assets/js/24.5bc3cf94.js"><link rel="prefetch" href="/assets/js/240.f7f4c0ba.js"><link rel="prefetch" href="/assets/js/241.65fc5fa2.js"><link rel="prefetch" href="/assets/js/243.3f9577d5.js"><link rel="prefetch" href="/assets/js/244.9649ec6d.js"><link rel="prefetch" href="/assets/js/245.fdcca161.js"><link rel="prefetch" href="/assets/js/246.c83c6714.js"><link rel="prefetch" href="/assets/js/247.6677979b.js"><link rel="prefetch" href="/assets/js/248.97ea5089.js"><link rel="prefetch" href="/assets/js/249.d7170cdf.js"><link rel="prefetch" href="/assets/js/25.b67b3873.js"><link rel="prefetch" href="/assets/js/250.8adf3d86.js"><link rel="prefetch" href="/assets/js/251.86300af7.js"><link rel="prefetch" href="/assets/js/252.0e3ede05.js"><link rel="prefetch" href="/assets/js/253.586d912a.js"><link rel="prefetch" href="/assets/js/254.f521f0b4.js"><link rel="prefetch" href="/assets/js/255.0c8cdb1a.js"><link rel="prefetch" href="/assets/js/256.ec7f9c17.js"><link rel="prefetch" href="/assets/js/257.6dc36fca.js"><link rel="prefetch" href="/assets/js/258.9930d469.js"><link rel="prefetch" href="/assets/js/259.bdc389e2.js"><link rel="prefetch" href="/assets/js/26.d41155d3.js"><link rel="prefetch" href="/assets/js/260.7244b3ab.js"><link rel="prefetch" href="/assets/js/261.a0afac4b.js"><link rel="prefetch" href="/assets/js/262.431d6a82.js"><link rel="prefetch" href="/assets/js/263.c0899c3e.js"><link rel="prefetch" href="/assets/js/264.64a2a420.js"><link rel="prefetch" href="/assets/js/265.b0cad44b.js"><link rel="prefetch" href="/assets/js/266.21b77a2f.js"><link rel="prefetch" href="/assets/js/27.3c4a072d.js"><link rel="prefetch" href="/assets/js/28.4e74f69f.js"><link rel="prefetch" href="/assets/js/29.14f28039.js"><link rel="prefetch" href="/assets/js/3.2f237a9d.js"><link rel="prefetch" href="/assets/js/30.36410792.js"><link rel="prefetch" href="/assets/js/31.6ffd719e.js"><link rel="prefetch" href="/assets/js/32.bfd5c2e9.js"><link rel="prefetch" href="/assets/js/33.16929d80.js"><link rel="prefetch" href="/assets/js/34.361a9575.js"><link rel="prefetch" href="/assets/js/35.1c66b905.js"><link rel="prefetch" href="/assets/js/36.53256ba6.js"><link rel="prefetch" href="/assets/js/37.da2558ed.js"><link rel="prefetch" href="/assets/js/38.30d9e621.js"><link rel="prefetch" href="/assets/js/39.4818defd.js"><link rel="prefetch" href="/assets/js/4.7d5f245c.js"><link rel="prefetch" href="/assets/js/40.636eea27.js"><link rel="prefetch" href="/assets/js/41.0018ba6b.js"><link rel="prefetch" href="/assets/js/42.6ecc2862.js"><link rel="prefetch" href="/assets/js/43.58a75ee3.js"><link rel="prefetch" href="/assets/js/44.74a32a06.js"><link rel="prefetch" href="/assets/js/45.03250a20.js"><link rel="prefetch" href="/assets/js/46.52f68306.js"><link rel="prefetch" href="/assets/js/47.36e85e4f.js"><link rel="prefetch" href="/assets/js/48.49d57bca.js"><link rel="prefetch" href="/assets/js/49.b38b2ad5.js"><link rel="prefetch" href="/assets/js/5.d87988f8.js"><link rel="prefetch" href="/assets/js/50.56cc433e.js"><link rel="prefetch" href="/assets/js/51.c40a0825.js"><link rel="prefetch" href="/assets/js/52.63567257.js"><link rel="prefetch" href="/assets/js/53.3e42ed99.js"><link rel="prefetch" href="/assets/js/54.2761720e.js"><link rel="prefetch" href="/assets/js/55.4cb6db86.js"><link rel="prefetch" href="/assets/js/56.469a92f3.js"><link rel="prefetch" href="/assets/js/57.46afff20.js"><link rel="prefetch" href="/assets/js/58.7ef30381.js"><link rel="prefetch" href="/assets/js/59.744cb435.js"><link rel="prefetch" href="/assets/js/6.3a554393.js"><link rel="prefetch" href="/assets/js/60.094ab0a3.js"><link rel="prefetch" href="/assets/js/61.119e8b2e.js"><link rel="prefetch" href="/assets/js/62.565108d9.js"><link rel="prefetch" href="/assets/js/63.4c7edb02.js"><link rel="prefetch" href="/assets/js/64.54bb5e4b.js"><link rel="prefetch" href="/assets/js/65.42f707a8.js"><link rel="prefetch" href="/assets/js/66.c98dc6b7.js"><link rel="prefetch" href="/assets/js/67.ba6a3acd.js"><link rel="prefetch" href="/assets/js/68.a02a3b0b.js"><link rel="prefetch" href="/assets/js/69.cd233ec0.js"><link rel="prefetch" href="/assets/js/7.bab1dbf2.js"><link rel="prefetch" href="/assets/js/70.f1295eda.js"><link rel="prefetch" href="/assets/js/71.e1d95891.js"><link rel="prefetch" href="/assets/js/72.f5c3f64f.js"><link rel="prefetch" href="/assets/js/73.9d99f345.js"><link rel="prefetch" href="/assets/js/74.ad8f1d8c.js"><link rel="prefetch" href="/assets/js/75.c9fb45f8.js"><link rel="prefetch" href="/assets/js/76.b1d611d5.js"><link rel="prefetch" href="/assets/js/77.a04577e3.js"><link rel="prefetch" href="/assets/js/78.9ba11b90.js"><link rel="prefetch" href="/assets/js/79.420221c7.js"><link rel="prefetch" href="/assets/js/8.889a2b8d.js"><link rel="prefetch" href="/assets/js/80.9ec1d712.js"><link rel="prefetch" href="/assets/js/81.ecb47b58.js"><link rel="prefetch" href="/assets/js/82.778e423a.js"><link rel="prefetch" href="/assets/js/83.2b8384d4.js"><link rel="prefetch" href="/assets/js/84.cabc5b04.js"><link rel="prefetch" href="/assets/js/85.a094bd7c.js"><link rel="prefetch" href="/assets/js/86.cc9676aa.js"><link rel="prefetch" href="/assets/js/87.8a5e2ad5.js"><link rel="prefetch" href="/assets/js/88.35140b15.js"><link rel="prefetch" href="/assets/js/89.333e2b0b.js"><link rel="prefetch" href="/assets/js/9.b81dc625.js"><link rel="prefetch" href="/assets/js/90.2faba253.js"><link rel="prefetch" href="/assets/js/91.29ab2e40.js"><link rel="prefetch" href="/assets/js/92.8fa6f536.js"><link rel="prefetch" href="/assets/js/93.15279ab5.js"><link rel="prefetch" href="/assets/js/94.b576dde8.js"><link rel="prefetch" href="/assets/js/95.00c825c5.js"><link rel="prefetch" href="/assets/js/96.cb4857a8.js"><link rel="prefetch" href="/assets/js/97.7fd4177a.js"><link rel="prefetch" href="/assets/js/98.166528c5.js"><link rel="prefetch" href="/assets/js/99.4385d414.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3f949b7f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://open.weixin.qq.com/qr/code?username=a_javaboy" alt="江南一点雨" class="logo"> <span class="site-name can-hide">江南一点雨</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="http://www.javaboy.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  国际站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="http://www.itboyhub.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  国内站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="http://www.javaboy.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  国际站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="http://www.itboyhub.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  国内站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/ssm/" class="sidebar-heading clickable router-link-active open"><span>SSM</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable router-link-active"><span>Maven</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable router-link-active"><span>Spring</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable router-link-active"><span>SpringMVC</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable router-link-active"><span>MyBatis</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable router-link-active"><span>Spring 源码</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable router-link-active open"><span>SpringMVC 进阶</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ssm/springmvc_advance/flashmap.html" class="sidebar-link">参数传递</a></li><li><a href="/ssm/springmvc_advance/pathpattern.html" class="sidebar-link">路径匹配符</a></li><li><a href="/ssm/springmvc_advance/responsebodyadvice_requestbodyadvice.html" class="sidebar-link">参数/响应预处理</a></li><li><a href="/ssm/springmvc_advance/springmvc_init.html" class="sidebar-link">SpringMVC初始化流程分析</a></li><li><a href="/ssm/springmvc_advance/argument_resolver.html" class="sidebar-link">自定义参数解析器</a></li><li><a href="/ssm/springmvc_advance/argument_resolver2.html" class="sidebar-link">深入参数解析器</a></li><li><a href="/ssm/springmvc_advance/handler_method_return_value_handler.html" class="sidebar-link">处理器返回值再加工</a></li><li><a href="/ssm/springmvc_advance/framework_servlet.html" class="sidebar-link">深入 FrameworkServlet</a></li><li><a href="/ssm/springmvc_advance/dispatcher_servlet.html" class="sidebar-link">深入 DispatcherServlet</a></li><li><a href="/ssm/springmvc_advance/handler_mapping.html" aria-current="page" class="active sidebar-link">深入 HandlerMapping</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ssm/springmvc_advance/handler_mapping.html#_1-概览" class="sidebar-link">1.概览</a></li><li class="sidebar-sub-header"><a href="/ssm/springmvc_advance/handler_mapping.html#_2-abstracthandlermapping" class="sidebar-link">2.AbstractHandlerMapping</a></li><li class="sidebar-sub-header"><a href="/ssm/springmvc_advance/handler_mapping.html#_3-abstracturlhandlermapping" class="sidebar-link">3.AbstractUrlHandlerMapping</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ssm/springmvc_advance/handler_mapping.html#_3-1-simpleurlhandlermapping" class="sidebar-link">3.1 SimpleUrlHandlerMapping</a></li><li class="sidebar-sub-header"><a href="/ssm/springmvc_advance/handler_mapping.html#_3-2-abstractdetectingurlhandlermapping" class="sidebar-link">3.2 AbstractDetectingUrlHandlerMapping</a></li></ul></li><li class="sidebar-sub-header"><a href="/ssm/springmvc_advance/handler_mapping.html#_4-abstracthandlermethodmapping" class="sidebar-link">4.AbstractHandlerMethodMapping</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ssm/springmvc_advance/handler_mapping.html#_4-1-初始化流程" class="sidebar-link">4.1 初始化流程</a></li><li class="sidebar-sub-header"><a href="/ssm/springmvc_advance/handler_mapping.html#_4-2-请求处理" class="sidebar-link">4.2 请求处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/ssm/springmvc_advance/handler_mapping.html#_5-小结" class="sidebar-link">5.小结</a></li></ul></li><li><a href="/ssm/springmvc_advance/session_attribute.html" class="sidebar-link">SessionAttribute</a></li><li><a href="/ssm/springmvc_advance/handler_method.html" class="sidebar-link">深入 HandlerMethod</a></li><li><a href="/ssm/springmvc_advance/handler_adapter.html" class="sidebar-link">深入 HandlerAdapter</a></li><li><a href="/ssm/springmvc_advance/view_resolver.html" class="sidebar-link">深入 ViewResolver</a></li><li><a href="/ssm/springmvc_advance/default_view_name.html" class="sidebar-link">默认视图名</a></li><li><a href="/ssm/springmvc_advance/exception.html" class="sidebar-link">异常处理体系</a></li><li><a href="/ssm/springmvc_advance/servlet_3_0_fileupload.html" class="sidebar-link">Servlet3.0 文件上传</a></li><li><a href="/ssm/springmvc_advance/i18n.html" class="sidebar-link">国际化</a></li><li><a href="/ssm/springmvc_advance/theme_resolver.html" class="sidebar-link">深入 ThemeResolver</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/ssm/" class="sidebar-heading clickable router-link-active"><span>WebFlux</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/springboot/" class="sidebar-heading clickable"><span>SpringBoot</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable open"><span>基本配置</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/springboot/java-ssm.html" class="sidebar-link">纯 Java 搭建 SSM 项目</a></li><li><a href="/springboot/create.html" class="sidebar-link">三种创建方法</a></li><li><a href="/springboot/parent.html" class="sidebar-link">理解项目中的 parent</a></li><li><a href="/springboot/application.properties.html" class="sidebar-link">理解 application.properties</a></li><li><a href="/springboot/yaml.html" class="sidebar-link">yaml 配置</a></li><li><a href="/springboot/starter.html" class="sidebar-link">自定义 starter</a></li><li><a href="/springboot/conditional.html" class="sidebar-link">理解自动化配置原理</a></li><li><a href="/springboot/https.html" class="sidebar-link">配置 Https</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>整合视图层</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>Web开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>数据持久化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>整合 Redis</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>RESTful</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>安全管理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>其他</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/springboot/" class="sidebar-heading clickable"><span>面试题</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/oauth2/" class="sidebar-heading clickable"><span>OAuth2</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/oauth2/oauth2-info.html" class="sidebar-link">OAuth2 简介</a></li><li><a href="/oauth2/oauth2_authorization_code.html" class="sidebar-link">授权码模式</a></li><li><a href="/oauth2/oauth2-password-implicit.html" class="sidebar-link">四种认证模式</a></li><li><a href="/oauth2/oauth2-redis.html" class="sidebar-link">引入 Redis</a></li><li><a href="/oauth2/oauth2-jwt.html" class="sidebar-link">引入 JWT</a></li><li><a href="/oauth2/spring-cloud-oauth2.html" class="sidebar-link">微服务安全管理思路</a></li><li><a href="/oauth2/oauth2-sso.html" class="sidebar-link">单点登录</a></li><li><a href="/oauth2/github-oauth2.html" class="sidebar-link">接入 GitHub 第三方登录</a></li><li><a href="/oauth2/custom-token-info.html" class="sidebar-link">自定义返回的 Token 信息</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/springsecurity/" class="sidebar-heading clickable"><span>SpringSecurity</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/springsecurity/spring-security-guide.html" class="sidebar-link">Spring Security 简介</a></li><li><a href="/springsecurity/spring-security-form-login.html" class="sidebar-link">入门 Spring Security</a></li><li><a href="/springsecurity/spring-security-custom-formlogin.html" class="sidebar-link">定制表单登录</a></li><li><a href="/springsecurity/spring-security-json.html" class="sidebar-link">使用 JSON 交互</a></li><li><a href="/springsecurity/spring-security-authorization.html" class="sidebar-link">授权操作</a></li><li><a href="/springsecurity/spring-security-JdbcUserDetailsManager.html" class="sidebar-link">将用户数据存入数据库</a></li><li><a href="/springsecurity/springsecurity-springdatajpa.html" class="sidebar-link">Spring Data Jpa 做持久化</a></li><li><a href="/springsecurity/rememberme.html" class="sidebar-link">自动登录功能</a></li><li><a href="/springsecurity/rememberme-advance.html" class="sidebar-link">自动登录的安全风险</a></li><li><a href="/springsecurity/spring-security-vs-shiro.html" class="sidebar-link">Spring Security Vs Shiro</a></li><li><a href="/springsecurity/custom-authentication.html" class="sidebar-link">自定义认证逻辑(高级玩法)</a></li><li><a href="/springsecurity/details.html" class="sidebar-link">快速查看登录用户 IP</a></li><li><a href="/springsecurity/session-management.html" class="sidebar-link">自动踢掉前一个登录用户</a></li><li><a href="/springsecurity/springboot-vue-session-management.html" class="sidebar-link">Spring Boot + Vue 踢掉已登录用户</a></li><li><a href="/springsecurity/springsecurity-stricthttpfirewall.html" class="sidebar-link">HttpFirewall</a></li><li><a href="/springsecurity/springsecurity-sfa.html" class="sidebar-link">防御会话固定攻击</a></li><li><a href="/springsecurity/springsecurity-spring-session.html" class="sidebar-link">集群化环境处理 session 共享</a></li><li><a href="/springsecurity/springsecurity-csrf.html" class="sidebar-link">防御 CSRF 攻击</a></li><li><a href="/springsecurity/springsecurity-csrf-sourcecode.html" class="sidebar-link">CSRF 防御源码</a></li><li><a href="/springsecurity/springsecurity-passwordencoder.html" class="sidebar-link">密码加密的两种姿势</a></li><li><a href="/springsecurity/springsecurity-study.html" class="sidebar-link">Spring Security 要怎么学</a></li><li><a href="/springsecurity/springsecurity-ignoring.html" class="sidebar-link">两种资源放行策略</a></li><li><a href="/springsecurity/springsecurity-cas.html" class="sidebar-link">CAS 单点登录</a></li><li><a href="/springsecurity/springsecurity-casserver.html" class="sidebar-link">配置 CAS-Server</a></li><li><a href="/springsecurity/springsecurity-cas-mysql.html" class="sidebar-link">CAS 对接数据库</a></li><li><a href="/springsecurity/cas-login-page.html" class="sidebar-link">CAS 自定义登录页面</a></li><li><a href="/springsecurity/swagger-springsecurity.html" class="sidebar-link">在 Swagger 请求头中携带 Token</a></li><li><a href="/springsecurity/cors-springsecurity.html" class="sidebar-link">三种跨域场景总结</a></li><li><a href="/springsecurity/http-springsecurity.html" class="sidebar-link">HTTP 认证</a></li><li><a href="/springsecurity/authorize-springsecurity.html" class="sidebar-link">四种权限控制方式</a></li><li><a href="/springsecurity/passwordencoder.html" class="sidebar-link">多种加密方案共存</a></li><li><a href="/springsecurity/objectpostprocess.html" class="sidebar-link">ObjectPostProcessor</a></li><li><a href="/springsecurity/httpsecurity-and.html" class="sidebar-link">配置中的 and</a></li><li><a href="/springsecurity/springsecurity-exception.html" class="sidebar-link">异常处理机制</a></li><li><a href="/springsecurity/spring-security-securitycontext.html" class="sidebar-link">SecurityContext</a></li><li><a href="/springsecurity/springsecurity-login.html" class="sidebar-link">登录流程分析</a></li><li><a href="/springsecurity/springsecurity-vue-token.html" class="sidebar-link">文件上传携带令牌</a></li><li><a href="/springsecurity/spring-security-update-info.html" class="sidebar-link">动态更新已登录用户信息</a></li><li><a href="/springsecurity/spring-security-json-2.html" class="sidebar-link">使用 JSON 格式登录</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/redis/" class="sidebar-heading clickable"><span>Redis</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/redis/linux-redis.html" class="sidebar-link">Linux 上安装 Redis</a></li><li><a href="/redis/datatype.html" class="sidebar-link">Redis 中的五种数据类型简介</a></li><li><a href="/redis/string.html" class="sidebar-link">Redis 字符串 STRING 介绍</a></li><li><a href="/redis/string-bit.html" class="sidebar-link">BIT 相关命令</a></li><li><a href="/redis/list-set.html" class="sidebar-link">Redis 列表与集合</a></li><li><a href="/redis/hash-zset.html" class="sidebar-link">Redis 散列与有序集合</a></li><li><a href="/redis/pub-sub.html" class="sidebar-link">Redis 中的发布订阅和事务</a></li><li><a href="/redis/rdb.html" class="sidebar-link">Redis 快照持久化</a></li><li><a href="/redis/aof.html" class="sidebar-link">Redis 之 AOF 持久化</a></li><li><a href="/redis/master-slave-1.html" class="sidebar-link">Redis 主从复制(一)</a></li><li><a href="/redis/master-slave-2.html" class="sidebar-link">Redis 主从复制(二)</a></li><li><a href="/redis/cluster.html" class="sidebar-link">Redis 集群搭建</a></li><li><a href="/redis/jedis.html" class="sidebar-link">Jedis 使用</a></li><li><a href="/redis/springdata-redis.html" class="sidebar-link">Spring Data Redis 使用</a></li><li><a href="/redis/guide.html" class="sidebar-link">教程下载</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/docker/" class="sidebar-heading clickable"><span>Docker</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/docker/install.html" class="sidebar-link">入门及安装</a></li><li><a href="/docker/container-basic.html" class="sidebar-link">容器基本操作</a></li><li><a href="/docker/container-advanced.html" class="sidebar-link">容器高级操作</a></li><li><a href="/docker/images.html" class="sidebar-link">镜像基本操作</a></li><li><a href="/docker/dockerhub-newwork.html" class="sidebar-link">DockerHub 与容器网络</a></li><li><a href="/docker/data.html" class="sidebar-link">数据卷操作</a></li><li><a href="/docker/link.html" class="sidebar-link">容器连接</a></li><li><a href="/docker/container-arrangement.html" class="sidebar-link">容器编排入门</a></li><li><a href="/docker/mysql.html" class="sidebar-link">Docker 搭建 MySQL 主从复制</a></li><li><a href="/docker/download.html" class="sidebar-link">教程下载</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/mongodb/" class="sidebar-heading clickable"><span>MongoDB</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/mongodb/linux-install-mongodb.html" class="sidebar-link">Linux 上安装 MongoDB</a></li><li><a href="/mongodb/basic-operations.html" class="sidebar-link">基本操作</a></li><li><a href="/mongodb/data-types.html" class="sidebar-link">数据类型</a></li><li><a href="/mongodb/documents-update.html" class="sidebar-link">文档更新操作</a></li><li><a href="/mongodb/documents-query.html" class="sidebar-link">文档查询操作(一)</a></li><li><a href="/mongodb/documents-query-2.html" class="sidebar-link">文档查询操作(二)</a></li><li><a href="/mongodb/query-planner.html" class="sidebar-link">查看执行计划</a></li><li><a href="/mongodb/index-basic.html" class="sidebar-link">初识索引</a></li><li><a href="/mongodb/index-types.html" class="sidebar-link">各种类型的索引</a></li><li><a href="/mongodb/collections.html" class="sidebar-link">固定集合</a></li><li><a href="/mongodb/pipelines.html" class="sidebar-link">管道操作符(一)</a></li><li><a href="/mongodb/pipelines-2.html" class="sidebar-link">管道操作符(二)</a></li><li><a href="/mongodb/in-mapreduce.html" class="sidebar-link">MapReduce 使用</a></li><li><a href="/mongodb/replicaset-install.html" class="sidebar-link">副本集搭建</a></li><li><a href="/mongodb/replicaset-settings.html" class="sidebar-link">副本集配置</a></li><li><a href="/mongodb/replicaset-details.html" class="sidebar-link">副本集其他细节</a></li><li><a href="/mongodb/shard.html" class="sidebar-link">初识分片</a></li><li><a href="/mongodb/in-java.html" class="sidebar-link">Java 操作 MongoDB</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/mysql/" class="sidebar-heading clickable"><span>MySQL</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/mysql/mysql-read-write.html" class="sidebar-link">MySQL  读写分离环境搭建(一)</a></li><li><a href="/mysql/mysql-read-write-2.html" class="sidebar-link">MySQL  读写分离环境搭建(二)</a></li><li><a href="/mysql/mysql.html" class="sidebar-link">MySQL 只能做小项目？</a></li><li><a href="/mysql/mysql-sharding.html" class="sidebar-link">初识数据库切分</a></li><li><a href="/mysql/middleware.html" class="sidebar-link">What？Tomcat 竟然也算中间件？</a></li><li><a href="/mysql/mycat-install.html" class="sidebar-link">分布式数据库中间件 MyCat</a></li><li><a href="/mysql/mycat-rule.html" class="sidebar-link">数据库分片规则</a></li><li><a href="/mysql/mycat-id-autoincrement.html" class="sidebar-link">分布式数据库主键全局自增</a></li><li><a href="/mysql/mysql-high-performance.html" class="sidebar-link">给数据库减负的八个思路</a></li><li><a href="/mysql/mybatis-key-generated.html" class="sidebar-link">MyBatis 中主键回填</a></li><li><a href="/mysql/mybatis-@param.html" class="sidebar-link">MyBatis 中 @Param 注解使用场景</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/git/" class="sidebar-heading clickable"><span>Git</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/git/install.html" class="sidebar-link">Git 概述</a></li><li><a href="/git/basic.html" class="sidebar-link">Git 基本操作</a></li><li><a href="/git/delete.html" class="sidebar-link">Git 中的各种后悔药</a></li><li><a href="/git/branch.html" class="sidebar-link">Git 分支管理</a></li><li><a href="/git/remote.html" class="sidebar-link">Git 关联远程仓库</a></li><li><a href="/git/tag.html" class="sidebar-link">Git 标签管理</a></li><li><a href="/git/stash.html" class="sidebar-link">Git 工作区储藏</a></li><li><a href="/git/resources.html" class="sidebar-link">Git 学习资料</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>前面跟小伙伴们分享了 SpringMVC 一个大致的初始化流程以及请求的大致处理流程，在请求处理过程中，涉及到九大组件，分别是：</p> <ol><li>HandlerMapping</li> <li>HandlerAdapter</li> <li>HandlerExceptionResolver</li> <li>ViewResolver</li> <li>RequestToViewNameTranslator</li> <li>LocaleResolver</li> <li>ThemeResolver</li> <li>MultipartResolver</li> <li>FlashMapManager</li></ol> <p>这些组件相信小伙伴们在日常开发中多多少少都有涉及到，如果你对这些组件感到陌生，可以在公众号后台回复 <strong>ssm</strong>，免费获取松哥的入门视频教程。</p> <p>那么接下来的几篇文章，松哥想和大家深入分析这九大组件，从用法到源码，挨个分析，今天我们就先来看看这九大组件中的第一个 HandlerMapping。</p> <h2 id="_1-概览"><a href="#_1-概览" class="header-anchor">#</a> 1.概览</h2> <p>HandlerMapping 叫做处理器映射器，它的作用就是根据当前 request 找到对应的 Handler 和 Interceptor，然后封装成一个 HandlerExecutionChain 对象返回，我们来看下 HandlerMapping 接口：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HandlerMapping</span> <span class="token punctuation">{</span>
	<span class="token class-name">String</span> BEST_MATCHING_HANDLER_ATTRIBUTE <span class="token operator">=</span> <span class="token class-name">HandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.bestMatchingHandler&quot;</span><span class="token punctuation">;</span>
	<span class="token annotation punctuation">@Deprecated</span>
	<span class="token class-name">String</span> LOOKUP_PATH <span class="token operator">=</span> <span class="token class-name">HandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.lookupPath&quot;</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE <span class="token operator">=</span> <span class="token class-name">HandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.pathWithinHandlerMapping&quot;</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> BEST_MATCHING_PATTERN_ATTRIBUTE <span class="token operator">=</span> <span class="token class-name">HandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.bestMatchingPattern&quot;</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> INTROSPECT_TYPE_LEVEL_MAPPING <span class="token operator">=</span> <span class="token class-name">HandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.introspectTypeLevelMapping&quot;</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> URI_TEMPLATE_VARIABLES_ATTRIBUTE <span class="token operator">=</span> <span class="token class-name">HandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.uriTemplateVariables&quot;</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> MATRIX_VARIABLES_ATTRIBUTE <span class="token operator">=</span> <span class="token class-name">HandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.matrixVariables&quot;</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE <span class="token operator">=</span> <span class="token class-name">HandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.producibleMediaTypes&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">usesPathPatterns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token annotation punctuation">@Nullable</span>
	<span class="token class-name">HandlerExecutionChain</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，除了一堆声明的常量外，其实就一个需要实现的方法 getHandler，该方法的返回值就是我们所了解到的 HandlerExecutionChain。</p> <p>HandlerMapping 的继承关系如下：</p> <p><img src="http://img.itboyhub.com/2021/02/HandlerMapping.png" alt=""></p> <p>这个继承关系虽然看着有点绕，其实仔细观察就两大类：</p> <ul><li>AbstractHandlerMethodMapping</li> <li>AbstractUrlHandlerMapping</li></ul> <p>其他的都是一些辅助接口。</p> <p>AbstractHandlerMethodMapping 体系下的都是根据方法名进行匹配的，而 AbstractUrlHandlerMapping 体系下的都是根据 URL 路径进行匹配的，这两者有一个共同的父类 AbstractHandlerMapping，接下来我们就对这三个关键类进行详细分析。</p> <h2 id="_2-abstracthandlermapping"><a href="#_2-abstracthandlermapping" class="header-anchor">#</a> 2.AbstractHandlerMapping</h2> <p>AbstractHandlerMapping 实现了 HandlerMapping 接口，无论是通过 URL 进行匹配还是通过方法名进行匹配，都是通过继承 AbstractHandlerMapping 来实现的，所以 AbstractHandlerMapping 所做的事情其实就是一些公共的事情，将以一些需要具体处理的事情则交给子类去处理，这其实就是典型的模版方法模式。</p> <p>AbstractHandlerMapping 间接继承自 ApplicationObjectSupport，并重写了 initApplicationContext 方法（其实该方法也是一个模版方法），这也是 AbstractHandlerMapping 的初始化入口方法，我们一起来看下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
	<span class="token function">extendInterceptors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">detectMappedInterceptors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adaptedInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">initInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>三个方法都和拦截器有关。</p> <p><strong>extendInterceptors</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">extendInterceptors</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> interceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>extendInterceptors 是一个模版方法，可以在子类中实现，子类实现了该方法之后，可以对拦截器进行添加、删除或者修改，不过在 SpringMVC 的具体实现中，其实这个方法并没有在子类中进行实现。</p> <p><strong>detectMappedInterceptors</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">detectMappedInterceptors</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerInterceptor</span><span class="token punctuation">&gt;</span></span> mappedInterceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mappedInterceptors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">beansOfTypeIncludingAncestors</span><span class="token punctuation">(</span>
			<span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MappedInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>detectMappedInterceptors 方法会从 SpringMVC 容器以及 Spring 容器中查找所有 MappedInterceptor 类型的 Bean，查找到之后添加到 mappedInterceptors 属性中（其实就是全局的 adaptedInterceptors 属性）。一般来说，我们定义好一个拦截器之后，还要在 XML 文件中配置该拦截器，拦截器以及各种配置信息，最终就会被封装成一个 MappedInterceptor 对象。</p> <p><strong>initInterceptors</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Object</span> interceptor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Entry number &quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot; in interceptors array is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>adaptedInterceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">adaptInterceptor</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>initInterceptors 方法主要是进行拦截器的初始化操作，具体内容是将 interceptors 集合中的拦截器添加到 adaptedInterceptors 集合中。</p> <p>至此，我们看到，所有拦截器最终都会被存入 adaptedInterceptors 变量中。</p> <p>AbstractHandlerMapping 的初始化其实也就是拦截器的初始化过程。</p> <blockquote><p>为什么 AbstractHandlerMapping 中对拦截器如此重视呢？其实不是重视，大家想想，AbstractUrlHandlerMapping 和 AbstractHandlerMethodMapping 最大的区别在于查找处理器的区别，一旦处理器找到了，再去找拦截器，但是拦截器都是统一的，并没有什么明显区别，所以拦截器就统一在 AbstractHandlerMapping 中进行处理，而不会去 AbstractUrlHandlerMapping 或者 AbstractHandlerMethodMapping 中处理。</p></blockquote> <p>接下来我们再来看看 AbstractHandlerMapping#getHandler 方法，看看处理器是如何获取到的：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">HandlerExecutionChain</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token class-name">Object</span> handler <span class="token operator">=</span> <span class="token function">getHandlerInternal</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		handler <span class="token operator">=</span> <span class="token function">getDefaultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Bean name or resolved handler?</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">String</span> handlerName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> handler<span class="token punctuation">;</span>
		handler <span class="token operator">=</span> <span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>handlerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Ensure presence of cached lookupPath for interceptors and others</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ServletRequestPathUtils</span><span class="token punctuation">.</span><span class="token function">hasCachedPath</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">initLookupPath</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">HandlerExecutionChain</span> executionChain <span class="token operator">=</span> <span class="token function">getHandlerExecutionChain</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasCorsConfigurationSource</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">CorsUtils</span><span class="token punctuation">.</span><span class="token function">isPreFlightRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">CorsConfiguration</span> config <span class="token operator">=</span> <span class="token function">getCorsConfiguration</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getCorsConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">CorsConfiguration</span> globalConfig <span class="token operator">=</span> <span class="token function">getCorsConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCorsConfiguration</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
			config <span class="token operator">=</span> <span class="token punctuation">(</span>globalConfig <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> globalConfig<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">:</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			config<span class="token punctuation">.</span><span class="token function">validateAllowCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		executionChain <span class="token operator">=</span> <span class="token function">getCorsHandlerExecutionChain</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> executionChain<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> executionChain<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法的执行流程是这样的：</p> <ol><li>首先调用 getHandlerInternal 方法去尝试获取处理器，getHandlerInternal 方法也是一个模版方法，该方法将在子类中实现。</li> <li>如果没找到相应的处理器，则调用 getDefaultHandler 方法获取默认的处理器，我们在配置 HandlerMapping 的时候可以配置默认的处理器。</li> <li>如果找到的处理器是一个字符串，则根据该字符串找去 SpringMVC 容器中找到对应的 Bean。</li> <li>确保 lookupPath 存在，一会找对应的拦截器的时候会用到。</li> <li>找到 handler 之后，接下来再调用 getHandlerExecutionChain 方法获取 HandlerExecutionChain 对象。</li> <li>接下来 if 里边的是进行跨域处理的，获取到跨域的相关配置，然后进行验证&amp;配置，检查是否允许跨域。跨域这块的配置以及校验还是蛮有意思的，松哥以后专门写文章来和小伙伴们细聊。</li></ol> <p>接下来我们再来看看第五步的 getHandlerExecutionChain 方法的执行逻辑，正是在这个方法里边把 handler 变成了 HandlerExecutionChain：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">HandlerExecutionChain</span> <span class="token function">getHandlerExecutionChain</span><span class="token punctuation">(</span><span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">HandlerExecutionChain</span> chain <span class="token operator">=</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerExecutionChain</span> <span class="token operator">?</span>
			<span class="token punctuation">(</span><span class="token class-name">HandlerExecutionChain</span><span class="token punctuation">)</span> handler <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">HandlerExecutionChain</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HandlerInterceptor</span> interceptor <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>adaptedInterceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor <span class="token keyword">instanceof</span> <span class="token class-name">MappedInterceptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">MappedInterceptor</span> mappedInterceptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MappedInterceptor</span><span class="token punctuation">)</span> interceptor<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mappedInterceptor<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				chain<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>mappedInterceptor<span class="token punctuation">.</span><span class="token function">getInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			chain<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> chain<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里直接根据已有的 handler 创建一个新的 HandlerExecutionChain 对象，然后遍历 adaptedInterceptors 集合，该集合里存放的都是拦截器，如果拦截器的类型是 MappedInterceptor，则调用 matches 方法去匹配一下，看一下是否是拦截当前请求的拦截器，如果是，则调用 chain.addInterceptor 方法加入到 HandlerExecutionChain 对象中；如果就是一个普通拦截器，则直接加入到 HandlerExecutionChain 对象中。</p> <p>这就是 AbstractHandlerMapping#getHandler 方法的大致逻辑，可以看到，这里留了一个模版方法 getHandlerInternal 在子类中实现，接下来我们就来看看它的子类。</p> <h2 id="_3-abstracturlhandlermapping"><a href="#_3-abstracturlhandlermapping" class="header-anchor">#</a> 3.AbstractUrlHandlerMapping</h2> <p>AbstractUrlHandlerMapping，看名字就知道，都是按照 URL 地址来进行匹配的，它的原理就是将 URL 地址与对应的 Handler 保存在同一个 Map 中，当调用 getHandlerInternal 方法时，就根据请求的 URL 去 Map 中找到对应的 Handler 返回就行了。</p> <p>这里我们就先从他的 getHandlerInternal 方法开始看起：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getHandlerInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token class-name">String</span> lookupPath <span class="token operator">=</span> <span class="token function">initLookupPath</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Object</span> handler<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">usesPathPatterns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">RequestPath</span> path <span class="token operator">=</span> <span class="token class-name">ServletRequestPathUtils</span><span class="token punctuation">.</span><span class="token function">getParsedRequestPath</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		handler <span class="token operator">=</span> <span class="token function">lookupHandler</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> lookupPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		handler <span class="token operator">=</span> <span class="token function">lookupHandler</span><span class="token punctuation">(</span>lookupPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// We need to care for the default handler directly, since we need to</span>
		<span class="token comment">// expose the PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE for it as well.</span>
		<span class="token class-name">Object</span> rawHandler <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">matchesCharacter</span><span class="token punctuation">(</span>lookupPath<span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			rawHandler <span class="token operator">=</span> <span class="token function">getRootHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rawHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			rawHandler <span class="token operator">=</span> <span class="token function">getDefaultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rawHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Bean name or resolved handler?</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>rawHandler <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">String</span> handlerName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> rawHandler<span class="token punctuation">;</span>
				rawHandler <span class="token operator">=</span> <span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>handlerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">validateHandler</span><span class="token punctuation">(</span>rawHandler<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
			handler <span class="token operator">=</span> <span class="token function">buildPathExposingHandler</span><span class="token punctuation">(</span>rawHandler<span class="token punctuation">,</span> lookupPath<span class="token punctuation">,</span> lookupPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>首先找到 lookupPath，就是请求的路径。这个方法本身松哥就不多说了，之前在<a href="">Spring5 里边的新玩法！这种 URL 请求让我涨见识了！</a>一文中有过介绍。</li> <li>接下来就是调用 lookupHandler 方法获取 Handler 对象，lookupHandler 有一个重载方法，具体用哪个，主要看所使用的 URL 匹配模式，如果使用了最新的 PathPattern（Spring5 之后的），则使用三个参数的 lookupHandler；如果还是使用之前旧的 AntPathMatcher，则这里使用两个参数的 lookupHandler。</li> <li>如果前面没有获取到 handler 实例，则接下来再做各种尝试，去分别查找 RootHandler、DefaultHandler 等，如果找到的 Handler 是一个 String，则去 Spring 容器中查找该 String 对应的 Bean，再调用 validateHandler 方法来校验找到的 handler 和 request 是否匹配，不过这是一个空方法，子类也没有实现，所以可以忽略之。最后再通过 buildPathExposingHandler 方法给找到的 handler 添加一些参数。</li></ol> <p>这就是整个 getHandlerInternal 方法的逻辑，实际上并不难，里边主要涉及到 lookupHandler 和 buildPathExposingHandler 两个方法，需要和大家详细介绍下，我们分别来看。</p> <p><strong>lookupHandler</strong></p> <p>lookupHandler 有两个，我们分别来看。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">lookupHandler</span><span class="token punctuation">(</span><span class="token class-name">String</span> lookupPath<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token class-name">Object</span> handler <span class="token operator">=</span> <span class="token function">getDirectMatch</span><span class="token punctuation">(</span>lookupPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> handler<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Pattern match?</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> matchingPatterns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> registeredPattern <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>registeredPattern<span class="token punctuation">,</span> lookupPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			matchingPatterns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registeredPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useTrailingSlashMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registeredPattern<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>registeredPattern <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> lookupPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				matchingPatterns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registeredPattern <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">String</span> bestMatch <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> patternComparator <span class="token operator">=</span> <span class="token function">getPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPatternComparator</span><span class="token punctuation">(</span>lookupPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matchingPatterns<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		matchingPatterns<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>patternComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
		bestMatch <span class="token operator">=</span> matchingPatterns<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bestMatch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bestMatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>bestMatch<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bestMatch<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bestMatch<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
						<span class="token string">&quot;Could not find handler for best pattern match [&quot;</span> <span class="token operator">+</span> bestMatch <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// Bean name or resolved handler?</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> handlerName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> handler<span class="token punctuation">;</span>
			handler <span class="token operator">=</span> <span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>handlerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">validateHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> pathWithinMapping <span class="token operator">=</span> <span class="token function">getPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">extractPathWithinPattern</span><span class="token punctuation">(</span>bestMatch<span class="token punctuation">,</span> lookupPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// There might be multiple 'best patterns', let's make sure we have the correct URI template variables</span>
		<span class="token comment">// for all of them</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> uriTemplateVariables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> matchingPattern <span class="token operator">:</span> matchingPatterns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>patternComparator<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>bestMatch<span class="token punctuation">,</span> matchingPattern<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> vars <span class="token operator">=</span> <span class="token function">getPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">extractUriTemplateVariables</span><span class="token punctuation">(</span>matchingPattern<span class="token punctuation">,</span> lookupPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> decodedVars <span class="token operator">=</span> <span class="token function">getUrlPathHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decodePathVariables</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> vars<span class="token punctuation">)</span><span class="token punctuation">;</span>
				uriTemplateVariables<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>decodedVars<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">buildPathExposingHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> bestMatch<span class="token punctuation">,</span> pathWithinMapping<span class="token punctuation">,</span> uriTemplateVariables<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// No handler found...</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">getDirectMatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> urlPath<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token class-name">Object</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>urlPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Bean name or resolved handler?</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> handlerName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> handler<span class="token punctuation">;</span>
			handler <span class="token operator">=</span> <span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>handlerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">validateHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">buildPathExposingHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> urlPath<span class="token punctuation">,</span> urlPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>这里首先调用 getDirectMatch 方法直接去 handlerMap 中找对应的处理器，handlerMap 中就保存了请求 URL 和处理器的映射关系，具体的查找过程就是先去 handlerMap 中找，找到了，如果是 String，则去 Spring 容器中找对应的 Bean，然后调用 validateHandler 方法去验证（实际上没有验证，前面已经说了），最后调用 buildPathExposingHandler 方法添加拦截器。</li> <li>如果 getDirectMatch 方法返回值不为 null，则直接将查找到的 handler 返回，方法到此为止。那么什么情况下 getDirectMatch 方法的返回值不为 null 呢？简单来收就是没有使用通配符的情况下，请求地址中没有通配符，一个请求地址对应一个处理器，只有这种情况，getDirectMatch 方法返回值才不为 null，因为 handlerMap 中保存的是代码的定义，比如我们定义代码的时候，某个处理器的访问路径可能带有通配符，但是当我们真正发起请求的时候，请求路径里是没有通配符的，这个时候再去 handlerMap 中就找不对对应的处理器了。如果用到了定义接口时用到了通配符，则需要在下面的代码中继续处理。</li> <li>接下来处理通配符的情况。首先定义 matchingPatterns 集合，将当前请求路径和 handlerMap 集合中保存的请求路径规则进行对比，凡是能匹配上的规则都直接存入 matchingPatterns 集合中。具体处理中，还有一个 useTrailingSlashMatch 的可能，有的小伙伴 SpringMVC 用的不熟练，看到这里可能就懵了，这里是这样的，SpringMVC 中，默认是可以匹配结尾 <code>/</code> 的，举个简单例子，如果你定义的接口是 <code>/user</code>，那么请求路径可以是 <code>/user</code> 也可以 <code>/user/</code>，这两种默认都是支持的，所以这里的 useTrailingSlashMatch 分支主要是处理后面这种情况，处理方式很简单，就在 registeredPattern 后面加上 <code>/</code> 然后继续和请求路径进行匹配。</li> <li>由于一个请求 URL 可能会和定义的多个接口匹配上，所以 matchingPatterns 变量是一个数组，接下来就要对 matchingPatterns 进行排序，排序完成后，选择排序后的第一项作为最佳选项赋值给 bestMatch 变量。默认的排序规则是 AntPatternComparator，当然开发者也可以自定义。AntPatternComparator 中定义的优先级如下：</li></ol> <table><thead><tr><th style="text-align:left;">路由配置</th> <th style="text-align:left;">优先级</th></tr></thead> <tbody><tr><td style="text-align:left;">不含任何特殊符号的路径，如：配置路由<code>/a/b/c</code></td> <td style="text-align:left;">第一优先级</td></tr> <tr><td style="text-align:left;">带有<code>{}</code>的路径，如：<code>/a/{b}/c</code></td> <td style="text-align:left;">第二优先级</td></tr> <tr><td style="text-align:left;">带有正则的路径，如：<code>/a/{regex:\d{3}}/c</code></td> <td style="text-align:left;">第三优先级</td></tr> <tr><td style="text-align:left;">带有<code>*</code>的路径，如：<code>/a/b/*</code></td> <td style="text-align:left;">第四优先级</td></tr> <tr><td style="text-align:left;">带有<code>**</code>的路径，如：<code>/a/b/**</code></td> <td style="text-align:left;">第五优先级</td></tr> <tr><td style="text-align:left;">最模糊的匹配：<code>/**</code></td> <td style="text-align:left;">最低优先级</td></tr></tbody></table> <ol start="5"><li>找到 bestMatch 之后，接下来再根据 bestMatch 去 handlerMap 中找到对应的处理器，直接找如果没找到，就去检查 bestMatch 是否以 <code>/</code> 结尾，如果是以 <code>/</code> 结尾，则去掉结尾的 <code>/</code> 再去 handlerMap 中查找，如果还没找到，那就该抛异常出来了。如果找到的 handler 是 String 类型的，则再去 Spring 容器中查找对应的 Bean，接下来再调用 validateHandler 方法进行验证。</li> <li>接下来调用 extractPathWithinPattern 方法提取出映射路径，例如定义的接口规则是 <code>myroot/*.html</code>，请求路径是 <code>myroot/myfile.html</code>，那么最终获取到的就是 <code>myfile.html</code>。</li> <li>接下来的 for 循环是为了处理存在多个最佳匹配规则的情况，在第四步中，我们对 matchingPatterns 进行排序，排序完成后，选择第一项作为最佳选项赋值给 bestMatch，但是最佳选项可能会有多个，这里就是处理最佳选项有多个的情况。</li> <li>最后调用 buildPathExposingHandler 方法注册两个内部拦截器，该方法下文我会给大家详细介绍。</li></ol> <p>lookupHandler 还有一个重载方法，不过只要大家把这个方法的执行流程搞清楚了，重载方法其实很好理解，这里松哥就不再赘述了，唯一要说的就是重载方法用了 PathPattern 去匹配 URL 路径，而这个方法用了 AntPathMatcher 去匹配 URL 路径。</p> <p><strong>buildPathExposingHandler</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">buildPathExposingHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> rawHandler<span class="token punctuation">,</span> <span class="token class-name">String</span> bestMatchingPattern<span class="token punctuation">,</span>
		<span class="token class-name">String</span> pathWithinMapping<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> uriTemplateVariables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">HandlerExecutionChain</span> chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HandlerExecutionChain</span><span class="token punctuation">(</span>rawHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
	chain<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathExposingHandlerInterceptor</span><span class="token punctuation">(</span>bestMatchingPattern<span class="token punctuation">,</span> pathWithinMapping<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>uriTemplateVariables<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		chain<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UriTemplateVariablesHandlerInterceptor</span><span class="token punctuation">(</span>uriTemplateVariables<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> chain<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>buildPathExposingHandler 方法向 HandlerExecutionChain 中添加了两个拦截器 PathExposingHandlerInterceptor 和 UriTemplateVariablesHandlerInterceptor，这两个拦截器在各自的 preHandle 中分别向 request 对象添加了一些属性，具体添加的属性小伙伴们可以自行查看，这个比较简单，我就不多说了。</p> <p>在前面的方法中，涉及到一个重要的变量 handlerMap，我们定义的接口和处理器之间的关系都保存在这个变量中，那么这个变量是怎么初始化的呢？这就涉及到 AbstractUrlHandlerMapping 中的另一个方法 registerHandler：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerHandler</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> urlPaths<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> urlPath <span class="token operator">:</span> urlPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">registerHandler</span><span class="token punctuation">(</span>urlPath<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerHandler</span><span class="token punctuation">(</span><span class="token class-name">String</span> urlPath<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
	<span class="token class-name">Object</span> resolvedHandler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazyInitHandlers <span class="token operator">&amp;&amp;</span> handler <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">String</span> handlerName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> handler<span class="token punctuation">;</span>
		<span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>applicationContext<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>handlerName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			resolvedHandler <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>handlerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">Object</span> mappedHandler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>urlPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">!=</span> resolvedHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
					<span class="token string">&quot;Cannot map &quot;</span> <span class="token operator">+</span> <span class="token function">getHandlerDescription</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; to URL path [&quot;</span> <span class="token operator">+</span> urlPath <span class="token operator">+</span>
					<span class="token string">&quot;]: There is already &quot;</span> <span class="token operator">+</span> <span class="token function">getHandlerDescription</span><span class="token punctuation">(</span>mappedHandler<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; mapped.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>urlPath<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">setRootHandler</span><span class="token punctuation">(</span>resolvedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>urlPath<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;/*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">setDefaultHandler</span><span class="token punctuation">(</span>resolvedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>handlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>urlPath<span class="token punctuation">,</span> resolvedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPatternParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>pathPatternHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token function">getPatternParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>urlPath<span class="token punctuation">)</span><span class="token punctuation">,</span> resolvedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>registerHandler(String[],String) 方法有两个参数，第一个就是定义的请求路径，第二个参数则是处理器 Bean 的名字，第一个参数是一个数组，那是因为同一个处理器可以对应多个不同的请求路径。</p> <p>在重载方法 registerHandler(String,String) 里边，完成了 handlerMap 的初始化，具体流程如下：</p> <ol><li>如果没有设置 lazyInitHandlers，并且 handler 是 String 类型，那么就去 Spring 容器中找到对应的 Bean 赋值给 resolvedHandler。</li> <li>根据 urlPath 去 handlerMap 中查看是否已经有对应的处理器了，如果有的话，则抛出异常，一个 URL 地址只能对应一个处理器，这个很好理解。</li> <li>接下来根据 URL 路径，将处理器进行配置，最终添加到 handlerMap 变量中。</li></ol> <p>这就是 AbstractUrlHandlerMapping 的主要工作，其中 registerHandler 将在它的子类中调用。</p> <p>接下来我们来看 AbstractUrlHandlerMapping 的子类。</p> <h3 id="_3-1-simpleurlhandlermapping"><a href="#_3-1-simpleurlhandlermapping" class="header-anchor">#</a> 3.1 SimpleUrlHandlerMapping</h3> <p>为了方便处理，SimpleUrlHandlerMapping 中自己定义了一个 urlMap 变量，这样可以在注册之前做一些预处理，例如确保所有的 URL 都是以 <code>/</code> 开始。SimpleUrlHandlerMapping 在定义时重写了父类的 initApplicationContext 方法，并在该方法中调用了 registerHandlers，在 registerHandlers 中又调用了父类的 registerHandler 方法完成了 handlerMap 的初始化操作：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
	<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">registerHandlers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>urlMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerHandlers</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> urlMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>urlMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;No patterns in &quot;</span> <span class="token operator">+</span> <span class="token function">formatMappingName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		urlMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> handler<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token comment">// Prepend with slash if not already present.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				url <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// Remove whitespace from handler bean name.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">registerHandler</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这块代码很简单，实在没啥好说的，如果 URL 不是以 <code>/</code> 开头，则手动给它加上 <code>/</code> 即可。有小伙伴们可能要问了，urlMap 的值从哪里来？当然是从我们的配置文件里边来呀，像下面这样：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.web.servlet.handler.SimpleUrlHandlerMapping<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>urlMap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>map</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/aaa<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value-ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/hello<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>map</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_3-2-abstractdetectingurlhandlermapping"><a href="#_3-2-abstractdetectingurlhandlermapping" class="header-anchor">#</a> 3.2 AbstractDetectingUrlHandlerMapping</h3> <p>AbstractDetectingUrlHandlerMapping 也是 AbstractUrlHandlerMapping 的子类，但是它和 SimpleUrlHandlerMapping 有一些不一样的地方。</p> <p>不一样的是哪里呢？</p> <p>AbstractDetectingUrlHandlerMapping 会自动查找到 SpringMVC 容器以及 Spring 容器中的所有 beanName，然后根据 beanName 解析出对应的 URL 地址，再将解析出的 url 地址和对应的 beanName 注册到父类的 handlerMap 变量中。换句话说，如果你用了 AbstractDetectingUrlHandlerMapping，就不用像 SimpleUrlHandlerMapping 那样去挨个配置 URL 地址和处理器的映射关系了。我们来看下 AbstractDetectingUrlHandlerMapping#initApplicationContext 方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ApplicationContextException</span> <span class="token punctuation">{</span>
	<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">detectHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">detectHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
	<span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> beanNames <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>detectHandlersInAncestorContexts <span class="token operator">?</span>
			<span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">beanNamesForTypeIncludingAncestors</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">:</span>
			applicationContext<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> urls <span class="token operator">=</span> <span class="token function">determineUrlsForHandler</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">registerHandler</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>AbstractDetectingUrlHandlerMapping 重写了父类的 initApplicationContext 方法，并在该方法中调用了 detectHandlers 方法，在 detectHandlers 中，首先查找到所有的 beanName，然后调用 determineUrlsForHandler 方法分析出 beanName 对应的 URL，不过这里的 determineUrlsForHandler 方法是一个空方法，具体的实现在它的子类中，AbstractDetectingUrlHandlerMapping 只有一个子类 BeanNameUrlHandlerMapping，我们一起来看下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanNameUrlHandlerMapping</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractDetectingUrlHandlerMapping</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">determineUrlsForHandler</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> urls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>beanName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span> <span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> alias <span class="token operator">:</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>alias<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>这个类很简单，里边就一个 determineUrlsForHandler 方法，这个方法的执行逻辑也很简单，就判断 beanName 是不是以 <code>/</code> 开始，如果是，则将之作为 URL。</p> <p>如果我们想要在项目中使用 BeanNameUrlHandlerMapping，配置方式如下：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.javaboy.init.HelloController<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/hello<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>handlerMapping<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>注意，Controller 的 name 必须是以 <code>/</code> 开始，否则该 bean 不会被自动作为处理器。</p> <p>至此，AbstractUrlHandlerMapping 体系下的东西就和大家分享完了。</p> <h2 id="_4-abstracthandlermethodmapping"><a href="#_4-abstracthandlermethodmapping" class="header-anchor">#</a> 4.AbstractHandlerMethodMapping</h2> <p>AbstractHandlerMethodMapping 体系下只有三个类，分别是 AbstractHandlerMethodMapping、RequestMappingInfoHandlerMapping 以及 RequestMappingHandlerMapping，如下图：</p> <p><img src="http://img.itboyhub.com/2021/02/20210307171135.png" alt=""></p> <p>在前面第三小节的 AbstractUrlHandlerMapping 体系下，一个 Handler 一般就是一个类，但是在 AbstractHandlerMethodMapping 体系下，一个 Handler 就是一个 Mehtod，这也是我们目前使用 SpringMVC 时最常见的用法，即直接用 @RequestMapping 去标记一个方法，该方法就是一个 Handler。</p> <p>接下来我们就一起来看看 AbstractHandlerMethodMapping。</p> <h3 id="_4-1-初始化流程"><a href="#_4-1-初始化流程" class="header-anchor">#</a> 4.1 初始化流程</h3> <p>AbstractHandlerMethodMapping 类实现了 InitializingBean 接口，所以 Spring 容器会自动调用其 afterPropertiesSet 方法，在这里将完成初始化操作：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">initHandlerMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initHandlerMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> <span class="token function">getCandidateBeanNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>SCOPED_TARGET_NAME_PREFIX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">processCandidateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">handlerMethodsInitialized</span><span class="token punctuation">(</span><span class="token function">getHandlerMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getCandidateBeanNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>detectHandlerMethodsInAncestorContexts <span class="token operator">?</span>
			<span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">beanNamesForTypeIncludingAncestors</span><span class="token punctuation">(</span><span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">:</span>
			<span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processCandidateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		beanType <span class="token operator">=</span> <span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isHandler</span><span class="token punctuation">(</span>beanType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">detectHandlerMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，具体的初始化又是在 initHandlerMethods 方法中完成的，在该方法中，首先调用 getCandidateBeanNames 方法获取容器中所有的 beanName，然后调用 processCandidateBean 方法对这些候选的 beanName 进行处理，具体的处理思路就是根据 beanName 找到 beanType，然后调用 isHandler 方法判断该 beanType 是不是一个 Handler，isHandler 是一个空方法，在它的子类 RequestMappingHandlerMapping 中被实现了，该方法主要是检查该 beanType 上有没有 <code>@Controller</code> 或者 <code>@RequestMapping</code> 注解，如果有，说明这就是我们想要的 handler，接下来再调用 detectHandlerMethods 方法保存 URL 和 handler 的映射关系：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">detectHandlerMethods</span><span class="token punctuation">(</span><span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> handlerType <span class="token operator">=</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">String</span> <span class="token operator">?</span>
			<span class="token function">obtainApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> handler<span class="token punctuation">)</span> <span class="token operator">:</span> handler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>handlerType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> userType <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getUserClass</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> methods <span class="token operator">=</span> <span class="token class-name">MethodIntrospector</span><span class="token punctuation">.</span><span class="token function">selectMethods</span><span class="token punctuation">(</span>userType<span class="token punctuation">,</span>
				<span class="token punctuation">(</span><span class="token class-name">MethodIntrospector</span><span class="token punctuation">.</span><span class="token class-name">MetadataLookup</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> method <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> <span class="token function">getMappingForMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> userType<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid mapping on handler class [&quot;</span> <span class="token operator">+</span>
								userType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]: &quot;</span> <span class="token operator">+</span> method<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> mapping<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token class-name">Method</span> invocableMethod <span class="token operator">=</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">selectInvocableMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> userType<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">registerHandlerMethod</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> invocableMethod<span class="token punctuation">,</span> mapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>首先找到 handler 的类型 handlerType。</li> <li>调用 ClassUtils.getUserClass 方法检查是否是 cglib 代理的子对象类型，如果是，则返回父类型，否则将参数直接返回。</li> <li>接下来调用 MethodIntrospector.selectMethods 方法获取当前 bean 中所有符合要求的 method。</li> <li>遍历 methods，调用 registerHandlerMethod 方法完成注册。</li></ol> <p>上面这段代码里又涉及到两个方法：</p> <ul><li>getMappingForMethod</li> <li>registerHandlerMethod</li></ul> <p>我们分别来看：</p> <p><strong>getMappingForMethod</strong></p> <p>getMappingForMethod 是一个模版方法，具体的实现也是在子类 RequestMappingHandlerMapping 里边：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">RequestMappingInfo</span> <span class="token function">getMappingForMethod</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> handlerType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">RequestMappingInfo</span> info <span class="token operator">=</span> <span class="token function">createRequestMappingInfo</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">RequestMappingInfo</span> typeInfo <span class="token operator">=</span> <span class="token function">createRequestMappingInfo</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>typeInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			info <span class="token operator">=</span> typeInfo<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">String</span> prefix <span class="token operator">=</span> <span class="token function">getPathPrefix</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>prefix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			info <span class="token operator">=</span> <span class="token class-name">RequestMappingInfo</span><span class="token punctuation">.</span><span class="token function">paths</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> info<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先根据 method 对象，调用 createRequestMappingInfo 方法获取一个 RequestMappingInfo，一个 RequestMappingInfo 包含了一个接口定义的详细信息，例如参数、header、produces、consumes、请求方法等等信息都在这里边。接下来再根据 handlerType 也获取一个 RequestMappingInfo，并调用 combine 方法将两个 RequestMappingInfo 进行合并。接下来调用 getPathPrefix 方法查看 handlerType 上有没有 URL 前缀，如果有，就添加到 info 里边去，最后将 info 返回。</p> <p>这里要说一下 handlerType 里边的这个前缀是那里来的，我们可以在 Controller 上使用 <code>@RequestMapping</code> 注解，配置一个路径前缀，这样 Controller 中的所有方法都加上了该路径前缀，但是这种方式需要一个一个的配置，如果想一次性配置所有的 Controller 呢？我们可以使用 Spring5.1 中新引入的方法 addPathPrefix 来配置，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configurePathMatch</span><span class="token punctuation">(</span><span class="token class-name">PathMatchConfigurer</span> configurer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        configurer<span class="token punctuation">.</span><span class="token function">setPatternParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathPatternParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPrefix</span><span class="token punctuation">(</span><span class="token string">&quot;/itboyhub&quot;</span><span class="token punctuation">,</span> <span class="token class-name">HandlerTypePredicate</span><span class="token punctuation">.</span><span class="token function">forAnnotation</span><span class="token punctuation">(</span><span class="token class-name">RestController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面这个配置表示，所有的 <code>@RestController</code> 标记的类都自动加上 <code>itboyhub</code> 前缀。有了这个配置之后，上面的 getPathPrefix 方法获取到的就是 <code>/itboyhub</code> 了。</p> <p><strong>registerHandlerMethod</strong></p> <p>当找齐了 URL 和 handlerMethod 之后，接下来就是将这些信息保存下来，方式如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerHandlerMethod</span><span class="token punctuation">(</span><span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">T</span> mapping<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>mappingRegistry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">T</span> mapping<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token class-name">HandlerMethod</span> handlerMethod <span class="token operator">=</span> <span class="token function">createHandlerMethod</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">validateMethodMapping</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">,</span> mapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> directPaths <span class="token operator">=</span> <span class="token class-name">AbstractHandlerMethodMapping</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDirectPaths</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> path <span class="token operator">:</span> directPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>pathLookup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> mapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getNamingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			name <span class="token operator">=</span> <span class="token function">getNamingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">,</span> mapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">addMappingName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> handlerMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">CorsConfiguration</span> corsConfig <span class="token operator">=</span> <span class="token function">initCorsConfiguration</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> method<span class="token punctuation">,</span> mapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>corsConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			corsConfig<span class="token punctuation">.</span><span class="token function">validateAllowCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>corsLookup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">,</span> corsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">MappingRegistration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> handlerMethod<span class="token punctuation">,</span> directPaths<span class="token punctuation">,</span> name<span class="token punctuation">,</span> corsConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">finally</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>首先调用 createHandlerMethod 方法创建 HandlerMethod 对象。</li> <li>调用 validateMethodMapping 方法对 handlerMethod 进行验证，主要是验证 handlerMethod 是否已经存在。</li> <li>从 mappings 中提取出 directPaths，就是不包含通配符的请求路径，然后将请求路径和 mapping 的映射关系保存到 pathLookup 中。</li> <li>找到所有 handler 的简称，调用 addMappingName 方法添加到 nameLookup 中。例如我们在 HelloController 中定义了一个名为 hello 的请求接口，那么这里拿到的就是 <code>HC#hello</code>，HC 是 HelloController 中的大写字母。</li> <li>初始化跨域配置，并添加到 corsLookup 中。</li> <li>将构建好的关系添加到 registry 中。</li></ol> <p>多说一句，第四步这个东西有啥用呢？这个其实是 Spring4 中开始增加的功能，算是一个小彩蛋吧，虽然日常开发很少用，但是我这里还是和大家说一下。</p> <p>假如你有如下一个接口：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/javaboy&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/aaa&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello99</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;aaa&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当你请求该接口的时候，不想通过路径，想直接通过方法名，行不行呢？当然可以！</p> <p>在 jsp 文件中，添加如下超链接：</p> <div class="language-jsp extra-class"><pre class="language-text"><code>&lt;%@ taglib prefix=&quot;s&quot; uri=&quot;http://www.springframework.org/tags&quot; %&gt;
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;a href=&quot;${s:mvcUrl('HC#hello99').build()}&quot;&gt;Go!&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><p>当这个 jsp 页面渲染完成后，href 属性就自动成了 hello99 方法的请求路径了。这个功能的实现，就依赖于前面第四步的内容。</p> <p>至此，我们就把 AbstractHandlerMethodMapping 的初始化流程看完了。</p> <h3 id="_4-2-请求处理"><a href="#_4-2-请求处理" class="header-anchor">#</a> 4.2 请求处理</h3> <p>接下来我们来看下当请求到来后，AbstractHandlerMethodMapping 会如何处理。</p> <p>和前面第三小节一样，这里处理请求的入口方法也是 getHandlerInternal，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">HandlerMethod</span> <span class="token function">getHandlerInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token class-name">String</span> lookupPath <span class="token operator">=</span> <span class="token function">initLookupPath</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>mappingRegistry<span class="token punctuation">.</span><span class="token function">acquireReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token class-name">HandlerMethod</span> handlerMethod <span class="token operator">=</span> <span class="token function">lookupHandlerMethod</span><span class="token punctuation">(</span>lookupPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>handlerMethod <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> handlerMethod<span class="token punctuation">.</span><span class="token function">createWithResolvedBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">finally</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>mappingRegistry<span class="token punctuation">.</span><span class="token function">releaseReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">HandlerMethod</span> <span class="token function">lookupHandlerMethod</span><span class="token punctuation">(</span><span class="token class-name">String</span> lookupPath<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Match</span><span class="token punctuation">&gt;</span></span> matches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> directPathMatches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappingRegistry<span class="token punctuation">.</span><span class="token function">getMappingsByDirectPath</span><span class="token punctuation">(</span>lookupPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>directPathMatches <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">addMatchingMappings</span><span class="token punctuation">(</span>directPathMatches<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>matches<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">addMatchingMappings</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappingRegistry<span class="token punctuation">.</span><span class="token function">getRegistrations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> matches<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matches<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Match</span> bestMatch <span class="token operator">=</span> matches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Match</span><span class="token punctuation">&gt;</span></span> comparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchComparator</span><span class="token punctuation">(</span><span class="token function">getMappingComparator</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			matches<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
			bestMatch <span class="token operator">=</span> matches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CorsUtils</span><span class="token punctuation">.</span><span class="token function">isPreFlightRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Match</span> match <span class="token operator">:</span> matches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">.</span><span class="token function">hasCorsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">Match</span> secondBestMatch <span class="token operator">=</span> matches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>comparator<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>bestMatch<span class="token punctuation">,</span> secondBestMatch<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">Method</span> m1 <span class="token operator">=</span> bestMatch<span class="token punctuation">.</span><span class="token function">getHandlerMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">Method</span> m2 <span class="token operator">=</span> secondBestMatch<span class="token punctuation">.</span><span class="token function">getHandlerMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
							<span class="token string">&quot;Ambiguous handler methods mapped for '&quot;</span> <span class="token operator">+</span> uri <span class="token operator">+</span> <span class="token string">&quot;': {&quot;</span> <span class="token operator">+</span> m1 <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> m2 <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>BEST_MATCHING_HANDLER_ATTRIBUTE<span class="token punctuation">,</span> bestMatch<span class="token punctuation">.</span><span class="token function">getHandlerMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">handleMatch</span><span class="token punctuation">(</span>bestMatch<span class="token punctuation">.</span>mapping<span class="token punctuation">,</span> lookupPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> bestMatch<span class="token punctuation">.</span><span class="token function">getHandlerMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">handleNoMatch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappingRegistry<span class="token punctuation">.</span><span class="token function">getRegistrations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lookupPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里就比较容易，通过 lookupHandlerMethod 找到对应的 HandlerMethod 返回即可，如果 lookupHandlerMethod 方法返回值不为 null，则通过 createWithResolvedBean 创建 HandlerMethod（主要是确认里边的 Bean 等），具体的创建过程松哥在后面的文章中会专门和大家分享。lookupHandlerMethod 方法也比较容易：</p> <ol><li>首先根据 lookupPath 找到匹配条件 directPathMatches，然后将获取到的匹配条件添加到 matches 中（不包含通配符的请求走这里）。</li> <li>如果 matches 为空，说明根据 lookupPath 没有找到匹配条件，那么直接将所有匹配条件加入 matches 中（包含通配符的请求走这里）。</li> <li>对 matches 进行排序，并选择排序后的第一个为最佳匹配项，如果前两个排序相同，则抛出异常。</li></ol> <p>大致的流程就是这样，具体到请求并没有涉及到它的子类。</p> <h2 id="_5-小结"><a href="#_5-小结" class="header-anchor">#</a> 5.小结</h2> <p>SpringMVC 九大组件，今天和小伙伴们把 HandlerMapping 过了一遍，其实只要认真看，这里并没有难点。如果小伙伴们觉得阅读吃力，也可以在公众号后台回复 ssm，查看松哥录制的免费入门教程～</p> <p>剩下的八大组件源码解析，小伙伴们敬请期待！</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ssm/springmvc_advance/dispatcher_servlet.html" class="prev">
        深入 DispatcherServlet
      </a></span> <span class="next"><a href="/ssm/springmvc_advance/session_attribute.html">
        SessionAttribute
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.93cfb041.js" defer></script><script src="/assets/js/2.afd40777.js" defer></script><script src="/assets/js/242.0491824c.js" defer></script>
  </body>
</html>
