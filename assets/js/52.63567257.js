(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{415:function(t,r,e){"use strict";e.r(r);var _=e(42),v=Object(_.a)({},(function(){var t=this,r=t.$createElement,e=t._self._c||r;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("前面和大家介绍了 MyCat 中数据库不同的分片规则，从留言中看出大家对分布式数据库中间件还挺感兴趣，因此今天就再来一篇，聊一聊主键全局自增要如何实现。")]),t._v(" "),e("p",[t._v("关于数据库分库分表的问题，我们前面还有几篇铺垫的文章，阅读前面的文章有助于更好的理解本文：")]),t._v(" "),e("hr"),t._v(" "),e("ol",[e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/_lsNyXHrsu131mHONQi5rg",target:"_blank",rel:"noopener noreferrer"}},[t._v("提高性能，MySQL 读写分离环境搭建(一)"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/SC0OYM6yO_GxQh9DvSsnoQ",target:"_blank",rel:"noopener noreferrer"}},[t._v("提高性能，MySQL 读写分离环境搭建(二)"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/bcyjBgEqg6Or5zdi4jHaiA",target:"_blank",rel:"noopener noreferrer"}},[t._v("MySQL 只能做小项目？松哥要说几句公道话！"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/qUGANVj2mmoMwUZEV5Zc1w",target:"_blank",rel:"noopener noreferrer"}},[t._v("北冥有 Data，其名为鲲，鲲之大，一个 MySQL 放不下！"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/7pj5E2HvmiejBJrW0T86oQ",target:"_blank",rel:"noopener noreferrer"}},[t._v("What？Tomcat 竟然也算中间件？"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/qWf5XZzhgpSuIGpE2T6iJg",target:"_blank",rel:"noopener noreferrer"}},[t._v("分布式数据库中间件 MyCat 搞起来！"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/4DvKAKiG2sFe_vEQ0mUkeQ",target:"_blank",rel:"noopener noreferrer"}},[t._v("数据库分库分表，分片配置轻松入门！"),e("OutboundLink")],1)])]),t._v(" "),e("hr"),t._v(" "),e("h2",{attrs:{id:"问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),e("p",[t._v("主键自增这应该算是一个非常常见的需求，在单机数据库中，这个需求一个 "),e("code",[t._v("auto_increment")]),t._v(" 就能实现，但是在数据库集群中，这个需求却变复杂了，因为存在多个数据库实例 ，各自都是主键自增，合在一起就不是主键自增了。")]),t._v(" "),e("h2",{attrs:{id:"最简单的思路"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#最简单的思路"}},[t._v("#")]),t._v(" 最简单的思路")]),t._v(" "),e("p",[t._v("最简单的办法莫过于通过设置主键自增的步长和起始偏移量来处理这个问题。默认情况下，主键自增步长为 1 ，如果我们有三个数据库实例，我们可以将主键自增步长设置为 3 ，这样对于第一个数据库实例而言，主键自增就是 1、4、7、10...，对于第二个数据库实例而言，主键自增就是 2、5、8、11...，对于第三个数据库实例而言，主键自增就是 3、6、9、12....。")]),t._v(" "),e("p",[t._v("MSSQL 可以直接在 SQL 中指定主键的自增步长和起始偏移量，但是 MySQL 则需要修改数据库配置才能实现，因此这里不推荐使用这种方式。")]),t._v(" "),e("h2",{attrs:{id:"mycat-的办法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mycat-的办法"}},[t._v("#")]),t._v(" MyCat 的办法")]),t._v(" "),e("p",[t._v("MyCat 作为一个分布式数据库中间，屏蔽了数据库集群的操作，让我们操作数据库集群就像操作单机版数据库一样，对于主键自增，它有自己的方案：")]),t._v(" "),e("ol",[e("li",[t._v("通过本地文件实现")]),t._v(" "),e("li",[t._v("通过数据库实现")]),t._v(" "),e("li",[t._v("通过本地时间戳实现")]),t._v(" "),e("li",[t._v("通过分布式 ZK ID 生成器实现")]),t._v(" "),e("li",[t._v("通过 ZK 递增方式实现")])]),t._v(" "),e("p",[t._v("今天我们就先来看看看如何通过 ZK 递增的方式实现主键全局自增。")]),t._v(" "),e("p",[t._v("配置步骤如下：")]),t._v(" "),e("ul",[e("li",[t._v("首先修改主键自增方式为 4 ，4 表示使用 zookeeper 实现主键自增。")])]),t._v(" "),e("p",[t._v("server.xml")]),t._v(" "),e("p",[e("img",{attrs:{src:"http://www.javaboy.org/images/mysql/9-1.png",alt:""}})]),t._v(" "),e("ul",[e("li",[t._v("配置表自增，并且设置主键")])]),t._v(" "),e("p",[t._v("schema.xml")]),t._v(" "),e("p",[e("img",{attrs:{src:"http://www.javaboy.org/images/mysql/9-2.png",alt:""}})]),t._v(" "),e("p",[t._v("设置主键自增，并且设置主键为 id 。")]),t._v(" "),e("ul",[e("li",[t._v("配置 zookeeper 的信息")])]),t._v(" "),e("p",[t._v("在 myid.properties 中配置 zookeeper 信息：")]),t._v(" "),e("p",[e("img",{attrs:{src:"http://www.javaboy.org/images/mysql/9-3.png",alt:""}})]),t._v(" "),e("ul",[e("li",[t._v("配置要自增的表")])]),t._v(" "),e("p",[t._v("sequence_conf.properties")]),t._v(" "),e("p",[e("img",{attrs:{src:"http://www.javaboy.org/images/mysql/9-4.png",alt:""}})]),t._v(" "),e("p",[t._v("注意，这里表名字要大写。")]),t._v(" "),e("ol",[e("li",[t._v("TABLE.MINID 某线程当前区间内最小值")]),t._v(" "),e("li",[t._v("TABLE.MAXID 某线程当前区间内最大值")]),t._v(" "),e("li",[t._v("TABLE.CURID 某线程当前区间内当前值")]),t._v(" "),e("li",[t._v("文件配置的MAXID以及MINID决定每次取得区间，这个对于每个线程或者进程都有效")]),t._v(" "),e("li",[t._v("文件中的这三个属性配置只对第一个进程的第一个线程有效，其他线程和进程会动态读取 ZK")])]),t._v(" "),e("ul",[e("li",[t._v("重启 MyCat 测试")])]),t._v(" "),e("p",[t._v("最后重启 MyCat ，删掉之前创建的表，然后创建新表进行测试即可。")]),t._v(" "),e("p",[t._v("好了，本文主要向大家介绍了 MyCat 实现主键全局自增的方案。不知道大家有没有 GET 到呢？有问题欢迎留言讨论。")])])}),[],!1,null,null,null);r.default=v.exports}}]);