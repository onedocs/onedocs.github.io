(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{409:function(s,t,a){"use strict";a.r(t);var r=a(42),e=Object(r.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("上篇文章我们搭建了 MongoDB 副本集的环境，验证了数据已经可以成功的复制，本文我们就来看看 MongoDB 副本集的其他操作。")]),s._v(" "),a("h2",{attrs:{id:"环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[s._v("#")]),s._v(" 环境准备")]),s._v(" "),a("p",[s._v("三台服务器，地址分别是：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("192.168.248.128\n192.168.248.135\n192.168.248.136\n")])])]),a("p",[s._v("按照上文介绍的步骤搭建副本集环境，这里不再赘述。")]),s._v(" "),a("h2",{attrs:{id:"副本集成员添加删除"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#副本集成员添加删除"}},[s._v("#")]),s._v(" 副本集成员添加删除")]),s._v(" "),a("p",[s._v("在副本集环境搭建好之后，我们可以利用如下命令删除一个副本集成员：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rs.remove('192.168.248.128:27017')\n")])])]),a("p",[s._v("上面的命令执行完成后，我们可以通过 rs.status() 命令来查看是否删除成功，也可以通过如下命令来为副本集添加一个成员：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rs.add('192.168.248.128:27017')\n")])])]),a("p",[s._v("当然，副本集也是可以更新的，使用 reconfig 命令即可，如下：")]),s._v(" "),a("p",[s._v("首先定义 config，如下：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('config={_id:"rs",members:[{_id:3,host:"192.168.248.128"},{_id:1,host:"192.168.248.135"}]}\n')])])]),a("p",[s._v("然后执行更新操作：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rs.reconfig(config)\n")])])]),a("p",[s._v("我们也可以利用 config=rs.config() 获取原始的 config 文件，然后进行修改，修改之后再执行 rs.reconfig(config)，如下：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('config=rs.config()\nconfig.members[0].host="192.168.248.136"\nrs.reconfig(config)\n')])])]),a("h2",{attrs:{id:"选举仲裁者"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#选举仲裁者"}},[s._v("#")]),s._v(" 选举仲裁者")]),s._v(" "),a("p",[s._v("在上文中给小伙伴们演示了主节点挂掉后的情况，和其他的(如 Redis )数据库主从复制不同，MongoDB 中主节点挂掉之后会自动从备份节点中选出一个新的主节点出来，这是一个选举的过程，投票选举，但是如果备份节点数为偶数的话，可能会出现两台服务器票数相等的情况，为了避免这种问题的出现，我们一般有两种解决方案：")]),s._v(" "),a("blockquote",[a("ol",[a("li",[s._v("数据节点为奇数个，这样就会避免上面描述的问题出现。")]),s._v(" "),a("li",[s._v("使用选举仲裁者，这是一种特殊的成员，仲裁者不保存数据，也不为客户端提供服务，只是在选举投票出现僵持时出来投个票，一个副本集中最多只能有一个仲裁者。")])])]),s._v(" "),a("p",[s._v("选举仲裁者占用的系统资源很小，因此对部署的服务器性能没多大要求，向副本集中添加仲裁者的方式如下：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rs.addArb('192.168.248.128:27017')\n")])])]),a("p",[s._v("也可以利用我们之前说的 reconfig 来操作：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("config=rs.config()\nconfig.members[2]={_id:2,host:'192.168.248.128',arbiterOnly:true}\nrs.reconfig(config)\n")])])]),a("p",[s._v("添加完成之后，我们可以通过 rs.status() 命令来查看是否添加成功，如果看到如下内容，表示添加成功：")]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.248.128:27017"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"health"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"state"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"stateStr"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ARBITER"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"uptime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lastHeartbeat"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" ISODate("),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017-11-03T08:56:12.406Z"')]),s._v(")"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lastHeartbeatRecv"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" ISODate("),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017-11-03T08:56:08.417Z"')]),s._v(")"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"pingMs"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" NumberLong("),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(")"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"configVersion"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("仲裁者的移除和普通节点的移除是一样的，这里不再赘述。")]),s._v(" "),a("h2",{attrs:{id:"优先级问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优先级问题"}},[s._v("#")]),s._v(" 优先级问题")]),s._v(" "),a("p",[s._v("优先级用来描述一个备份节点成为主节点的优先性问题，优先级的取值范围为 [0-100]，默认为 1，数字越大优先级越高，越有可能成为主节点，0 表示该节点永远不能成为主节点。")]),s._v(" "),a("p",[s._v("我们可以在添加节点时指定优先级，如下:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rs.add({_id:0,host:'192.168.248.128:27017',priority:2})\n")])])]),a("p",[s._v("也可以为已有的节点设置优先级：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("config=rs.config()\nconfig.members[0].priority=99\nrs.reconfig(config)\n")])])]),a("p",[s._v("好了，MongoDB 中副本集的配置我们就先说到这里，小伙伴们有问题欢迎留言讨论。")]),s._v(" "),a("p",[s._v("参考资料：")]),s._v(" "),a("ol",[a("li",[s._v("《MongoDB权威指南第2版》")])])])}),[],!1,null,null,null);t.default=e.exports}}]);